/*
 * Copyright 2023 gematik GmbH
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package de.gematik.test.fuzzing.fhirfuzz.playground;

import static java.text.MessageFormat.format;

import de.gematik.test.erezept.fhir.parser.EncodingType;
import de.gematik.test.erezept.fhir.resources.kbv.KbvErpBundle;
import de.gematik.test.erezept.fhir.testutil.ParsingTest;
import de.gematik.test.erezept.fhir.testutil.ValidatorUtil;
import java.io.BufferedWriter;
import java.io.FileWriter;
import java.nio.file.Path;
import java.util.LinkedList;
import java.util.List;
import lombok.SneakyThrows;
import lombok.extern.slf4j.Slf4j;
import lombok.val;
import org.hl7.fhir.r4.model.Bundle;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

@Slf4j
public class BundleValidatorTest extends ParsingTest {
  private static final List<String> invalidBundleList = new LinkedList();

  private static int counter;
  String stringBundle2 =
      """
<Bundle xmlns="http://hl7.org/fhir"><id value="18381476-28f6-4e2a-88f0-b53c837b79cc"/><meta><lastUpdated value="2024-03-06T11:19:26.820+01:00"/><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Bundle|1.1.0"/></meta><identifier><system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId"/><value value="160.000.226.177.010.32"/></identifier><type value="document"/><timestamp value="2024-03-06T11:19:26.820+01:00"/><entry><fullUrl value="https://pvs.gematik.de/fhir/Composition/feade350-3345-4d62-821e-d33ace65d9db"/><resource><Composition xmlns="http://hl7.org/fhir"><id value="feade350-3345-4d62-821e-d33ace65d9db"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Composition|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_FOR_Legal_basis"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_STATUSKENNZEICHEN"/><code value="00"/></valueCoding></extension><status value="final"/><type><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_FORMULAR_ART"/><code value="e16A"/></coding></type><subject><reference value="Patient/ee6da052-6fff-49c6-bcb9-975063504168"/></subject><date value="2024-03-06T11:19:26+01:00"/><author><reference value="Practitioner/3ed176a0-30a2-431b-9148-81d2549b9643"/><type value="Practitioner"/></author><author><type value="Device"/><identifier><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_FOR_Pruefnummer"/><value value="GEMATIK/410/2109/36/123"/></identifier></author><title value="elektronische Arzneimittelverordnung"/><custodian><reference value="Organization/863e3994-b5fa-41f2-a0e5-cbd86e08d86a"/></custodian><section><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Section_Type"/><code value="Coverage"/></coding></code><entry><reference value="Coverage/f15717a2-a4aa-4e03-aded-2c91e84eed92"/></entry></section><section><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Section_Type"/><code value="Prescription"/></coding></code><entry><reference value="MedicationRequest/49cc0348-a2d1-41a2-98ed-5049a4c4b07b"/></entry></section></Composition></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Medication/b7597658-75dc-426c-83dd-7ce8fe21e92a"/><resource><Medication xmlns="http://hl7.org/fhir"><id value="b7597658-75dc-426c-83dd-7ce8fe21e92a"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Medication_PZN|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_Base_Medication_Type"><valueCodeableConcept><coding><system value="http://snomed.info/sct"/><version value="http://snomed.info/sct/900000000000207008/version/20220331"/><code value="763158003"/><display value="Medicinal product (product)"/></coding></valueCodeableConcept></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Category"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Medication_Category"/><code value="00"/></valueCoding></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Vaccine"><valueBoolean value="false"/></extension><extension url="http://fhir.de/StructureDefinition/normgroesse"><valueCode value="N2"/></extension><code><coding><system value="http://fhir.de/CodeSystem/ifa/pzn"/><code value="08625372"/></coding><text value="Lora ADGC® Pastillen 550 mg"/></code><form><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DARREICHUNGSFORM"/><code value="IST"/></coding></form><amount><numerator><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_PackagingSize"><valueString value="19"/></extension><unit value="Stk"/></numerator><denominator><value value="1"/></denominator></amount></Medication></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Patient/ee6da052-6fff-49c6-bcb9-975063504168"/><resource><Patient xmlns="http://hl7.org/fhir"><id value="ee6da052-6fff-49c6-bcb9-975063504168"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Patient|1.1.0"/></meta><identifier><type><coding><system value="http://fhir.de/CodeSystem/identifier-type-de-basis"/><code value="GKV"/></coding></type><system value="http://fhir.de/sid/gkv/kvid-10"/><value value="X110498565"/></identifier><name><use value="official"/><family value="Hüllmann"><extension url="http://hl7.org/fhir/StructureDefinition/humanname-own-name"><valueString value="Hüllmann"/></extension></family><given value="Sina"/></name><birthDate value="1964-05-11"/><address><type value="both"/><line value="Lessingstr. 17"><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber"><valueString value="17"/></extension><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName"><valueString value="Lessingstr."/></extension></line><city value="Bruderberg"/><postalCode value="28410"/><country value="D"/></address></Patient></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Organization/863e3994-b5fa-41f2-a0e5-cbd86e08d86a"/><resource><Organization xmlns="http://hl7.org/fhir"><id value="863e3994-b5fa-41f2-a0e5-cbd86e08d86a"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Organization|1.1.0"/></meta><identifier><type><coding><system value="http://terminology.hl7.org/CodeSystem/v2-0203"/><code value="BSNR"/></coding></type><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_Base_BSNR"/><value value="478570398"/></identifier><name value="Arztpraxis Ulmenwald"/><telecom><system value="phone"/><value value="(03376) 2559663"/></telecom><telecom><system value="email"/><value value="annika.gamlin@rosksch.de"/></telecom><address><type value="both"/><line value="Jakobistr. 2"><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber"><valueString value="2"/></extension><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName"><valueString value="Jakobistr."/></extension></line><city value="Aureliaheim"/><postalCode value="65406"/><country value="D"/></address></Organization></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Coverage/f15717a2-a4aa-4e03-aded-2c91e84eed92"/><resource><Coverage xmlns="http://hl7.org/fhir"><id value="f15717a2-a4aa-4e03-aded-2c91e84eed92"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Coverage|1.1.0"/></meta><extension url="http://fhir.de/StructureDefinition/gkv/besondere-personengruppe"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_PERSONENGRUPPE"/><code value="00"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/dmp-kennzeichen"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DMP"/><code value="00"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/wop"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_ITA_WOP"/><code value="51"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/versichertenart"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_VERSICHERTENSTATUS"/><code value="1"/></valueCoding></extension><status value="active"/><type><coding><system value="http://fhir.de/CodeSystem/versicherungsart-de-basis"/><code value="GKV"/></coding></type><beneficiary><reference value="Patient/3b20bc3b-1665-427a-8bad-1d02241d8aae"/></beneficiary><payor><identifier><system value="http://fhir.de/sid/arge-ik/iknr"/><value value="103526615"/></identifier><display value="BKK VDN"/></payor></Coverage></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Practitioner/3ed176a0-30a2-431b-9148-81d2549b9643"/><resource><Practitioner xmlns="http://hl7.org/fhir"><id value="3ed176a0-30a2-431b-9148-81d2549b9643"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Practitioner|1.1.0"/></meta><identifier><type><coding><system value="http://terminology.hl7.org/CodeSystem/v2-0203"/><code value="LANR"/></coding></type><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_Base_ANR"/><value value="452554037"/></identifier><name><use value="official"/><family value="Ulmenwald"><extension url="http://hl7.org/fhir/StructureDefinition/humanname-own-name"><valueString value="Ulmenwald"/></extension></family><given value="Adelheid"/><prefix value="Dr."><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier"><valueCode value="AC"/></extension></prefix></name><qualification><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_Qualification_Type"/><code value="00"/></coding></code></qualification><qualification><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_Berufsbezeichnung"/><code value="Berufsbezeichnung"/></coding><text value="Super-Facharzt für alles Mögliche"/></code></qualification></Practitioner></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/MedicationRequest/49cc0348-a2d1-41a2-98ed-5049a4c4b07b"/><resource><MedicationRequest xmlns="http://hl7.org/fhir"><id value="49cc0348-a2d1-41a2-98ed-5049a4c4b07b"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Prescription|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_BVG"><valueBoolean value="true"/></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_EmergencyServicesFee"><valueBoolean value="false"/></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Multiple_Prescription"><extension url="Kennzeichen"><valueBoolean value="false"/></extension></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_FOR_StatusCoPayment"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_StatusCoPayment"/><code value="2"/></valueCoding></extension><status value="active"/><intent value="order"/><medicationReference><reference value="Medication/b7597658-75dc-426c-83dd-7ce8fe21e92a"/></medicationReference><subject><reference value="Patient/f0a02a72-ac2c-4990-be8c-060fa110da55"/></subject><authoredOn value="2024"/><requester><reference value="Practitioner/3ed176a0-30a2-431b-9148-81d2549b9643"/></requester><insurance><reference value="Coverage/3131be08-6fa2-45dd-9daa-978b98f0d867"/></insurance><dosageInstruction><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DosageFlag"><valueBoolean value="true"/></extension><text value="2-1-1-1-3-0-1"/></dosageInstruction><dispenseRequest><quantity><value value="3"/><system value="http://unitsofmeasure.org"/><code value="{Package}"/></quantity></dispenseRequest><substitution><allowedBoolean value="false"/></substitution></MedicationRequest></resource></entry></Bundle>

            """;
  String stringBundleXml =
      """
            <Bundle xmlns="http://hl7.org/fhir"><id value="1fb9caaE-8f98-4y75-8cdc-f9935e48cc91-"/><meta><lastUpdated value="2023-08-23T13:19:27.513+02:00"/><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Bundle|1.1.0"/></meta><identifier><system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId"/><value value="169.000.000.046.300.69"/></identifier><type value="document"/><timestamp value="2023-08-23T13:19:27.513+02:00"/><entry><fullUrl value="https://pvs.gematik.de/fhir/Composition/7beda127-e5c8-4cfb-87ec-462065d1bb5b"/><resource><Composition xmlns="http://hl7.org/fhir"><id value="7beda127-e5c8-4cfb-87ec-462065d1bb5b"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Composition|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_FOR_Legal_basis"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_STATUSKENNZEICHEN"/><code value="00"/></valueCoding></extension><status value="final"/><type><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_FORMULAR_ART"/><code value="e16A"/></coding></type><subject><reference value="Patient/71654243-0268-4730-9be2-a746c7708e9a"/></subject><date value="2023-08-23T13:19:27+02:00"/><author><reference value="Practitioner/221715c4-c94f-4ecf-b880-323bb2b17e66"/><type value="Practitioner"/></author><author><type value="Device"/><identifier><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_FOR_Pruefnummer"/><value value="GEMATIK/410/2109/36/123"/></identifier></author><title value="elektronische Arzneimittelverordnung"/><custodian><reference value="Organization/faaf6e64-9a3c-4fbe-8ff6-50374e7de6ca"/></custodian><section><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Section_Type"/><code value="Coverage"/></coding></code><entry><reference value="Coverage/d906e1c9-ea8f-42d2-bdf5-31260d46175d"/></entry></section><section><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Section_Type"/><code value="Prescription"/></coding></code><entry><reference value="MedicationRequest/6ed624f6-85f9-4b74-b5c6-66eb1aeb1c20"/></entry></section></Composition></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/MedicationRequest/6ed624f6-85f9-4b74-b5c6-66eb1aeb1c20"/><resource><MedicationRequest xmlns="http://hl7.org/fhir"><id value="6ed624f6-85f9-4b74-b5c6-66eb1aeb1c20"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Prescription|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_BVG"><valueBoolean value="true"/></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_EmergencyServicesFee"><valueBoolean value="false"/></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Multiple_Prescription"><extension url="Kennzeichen"><valueBoolean value="false"/></extension></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_FOR_StatusCoPayment"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_StatusCoPayment"/><code value="0"/></valueCoding></extension><status value="active"/><intent value="order"/><medicationReference><reference value="Medication/0b538d2d-a9c1-4300-9f07-e3cf17bdafe4"/></medicationReference><subject><reference value="Patient/c3f5e74d-6bbd-4291-ae70-9cc8a1016591"/></subject><authoredOn value="2023-08-23"/><requester><reference value="Practitioner/221715c4-c94f-4ecf-b880-323bb2b17e66"/></requester><insurance><reference value="Coverage/b9ee0afb-9960-48f9-9ed8-814ce7b37dc5"/></insurance><dosageInstruction><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DosageFlag"><valueBoolean value="true"/></extension><text value="0-0-0-1-0-2-0"/></dosageInstruction><dispenseRequest><quantity><value value="13"/><system value="http://unitsofmeasure.org"/><code value="{Package}"/></quantity></dispenseRequest><substitution><allowedBoolean value="true"/></substitution></MedicationRequest></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Medication/0b538d2d-a9c1-4300-9f07-e3cf17bdafe4"/><resource><Medication xmlns="http://hl7.org/fhir"><id value="0b538d2d-a9c1-4300-9f07-e3cf17bdafe4"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Medication_PZN|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_Base_Medication_Type"><valueCodeableConcept><coding><system value="http://snomed.info/sct"/><version value="http://snomed.info/sct/900000000000207008/version/20220331"/><code value="763158003"/><display value="Medicinal product (product)"/></coding></valueCodeableConcept></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Category"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Medication_Category"/><code value="00"/></valueCoding></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Vaccine"><valueBoolean value="false"/></extension><extension url="http://fhir.de/StructureDefinition/normgroesse"><valueCode value="KA"/></extension><code><coding><system value="http://fhir.de/CodeSystem/ifa/pzn"/><code value="96160220"/></coding><text value="Capimozol"/></code><form><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DARREICHUNGSFORM"/><code value="GMR"/></coding></form><amount><numerator><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_PackagingSize"><valueString value="11"/></extension><unit value="Stk"/></numerator><denominator><value value="1"/></denominator></amount></Medication></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Patient/71654243-0268-4730-9be2-a746c7708e9a"/><resource><Patient xmlns="http://hl7.org/fhir"><id value="71654243-0268-4730-9be2-a746c7708e9a"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Patient|1.1.0"/></meta><identifier><type><coding><system value="http://fhir.de/CodeSystem/identifier-type-de-basis"/><code value="GKV"/></coding></type><system value="http://fhir.de/sid/gkv/kvid-10"/><value value="X110498565"/></identifier><name><use value="official"/><family value="Hüllmann"><extension url="http://hl7.org/fhir/StructureDefinition/humanname-own-name"><valueString value="Hüllmann"/></extension></family><given value="Sina"/></name><birthDate value="1975-06-28"/><address><type value="both"/><line value="Görlitzer Str. 68b"><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber"><valueString value="68b"/></extension><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName"><valueString value="Görlitzer Str."/></extension></line><city value="Sebastianheim"/><postalCode value="58395"/><country value="D"/></address></Patient></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Organization/faaf6e64-9a3c-4fbe-8ff6-50374e7de6ca"/><resource><Organization xmlns="http://hl7.org/fhir"><id value="faaf6e64-9a3c-4fbe-8ff6-50374e7de6ca"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Organization|1.1.0"/></meta><identifier><type><coding><system value="http://terminology.hl7.org/CodeSystem/v2-0203"/><code value="BSNR"/></coding></type><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_Base_BSNR"/><value value="490808631"/></identifier><name value="Arztpraxis Claudius"/><telecom><system value="phone"/><value value="+49-8763-34048135"/></telecom><telecom><system value="email"/><value value="clarissa.stube@beckel.org"/></telecom><address><type value="both"/><line value="Hufer Weg 923"><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber"><valueString value="923"/></extension><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName"><valueString value="Hufer Weg"/></extension></line><city value="Lucland"/><postalCode value="19751"/><country value="D"/></address></Organization></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Coverage/d906e1c9-ea8f-42d2-bdf5-31260d46175d"/><resource><Coverage xmlns="http://hl7.org/fhir"><id value="d906e1c9-ea8f-42d2-bdf5-31260d46175d"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Coverage|1.1.0"/></meta><extension url="http://fhir.de/StructureDefinition/gkv/besondere-personengruppe"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_PERSONENGRUPPE"/><code value="00"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/dmp-kennzeichen"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DMP"/><code value="00"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/wop"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_ITA_WOP"/><code value="51"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/versichertenart"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_VERSICHERTENSTATUS"/><code value="1"/></valueCoding></extension><status value="active"/><type><coding><system value="http://fhir.de/CodeSystem/versicherungsart-de-basis"/><code value="GKV"/></coding></type><beneficiary><reference value="Patient/ae9a60be-fb09-48c7-bbac-feb8c5de294d"/></beneficiary><payor><identifier><system value="http://fhir.de/sid/arge-ik/iknr"/><value value="107832012"/></identifier><display value="BKK VerbundPlus"/></payor></Coverage></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Practitioner/221715c4-c94f-4ecf-b880-323bb2b17e66"/><resource><Practitioner xmlns="http://hl7.org/fhir"><id value="221715c4-c94f-4ecf-b880-323bb2b17e66"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Practitioner|1.1.0"/></meta><identifier><type><coding><system value="http://terminology.hl7.org/CodeSystem/v2-0203"/><code value="LANR"/></coding></type><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_Base_ANR"/><value value="629547897"/></identifier><name><use value="official"/><family value="Claudius"><extension url="http://hl7.org/fhir/StructureDefinition/humanname-own-name"><valueString value="Claudius"/></extension></family><given value="Bernd"/><prefix value="Dr."><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier"><valueCode value="AC"/></extension></prefix></name><qualification><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_Qualification_Type"/><code value="00"/></coding></code></qualification><qualification><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_Berufsbezeichnung"/><code value="Berufsbezeichnung"/></coding><text value="Super-Facharzt für alles Mögliche"/></code></qualification></Practitioner></resource></entry></Bundle>
            """;
  String bundle3 =
      """
            <Bundle xmlns="http://hl7.org/fhir"><id value="3995c4f3-1428-41e4-9bff-5a5afa6d7f89"/><meta><lastUpdated value="2023-08-28T16:59:36.483+02:00"/><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Bundle|1.0.2"/></meta><identifier><system value="https://gematik.de/fhir/NamingSystem/PrescriptionID"/><value value="160.000.006.374.401.16"/></identifier><type value="document"/><timestamp value="2023-08-28T16:59:36.483+02:00"/><entry><fullUrl value="https://pvs.gematik.de/fhir/Composition/ed9e343c-8f4f-4466-a793-c499dd7b89fb"/><resource><Composition xmlns="http://hl7.org/fhir"><id value="ed9e343c-8f4f-4466-a793-c499dd7b89fb"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Composition|1.0.2"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_FOR_Legal_basis"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_STATUSKENNZEICHEN"/><code value="00"/></valueCoding></extension><status value="final"/><type><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_FORMULAR_ART"/><code value="e16A"/></coding></type><subject><reference value="Patient/d3da6235-94cf-4e1a-832c-ff0a4b631e45"/></subject><date value="2023-08-28T16:59:36+02:00"/><author><reference value="Practitioner/ac41f1fa-5492-47a5-8da3-788896061c8b"/><type value="Practitioner"/></author><author><type value="Device"/><identifier><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_FOR_Pruefnummer"/><value value="GEMATIK/410/2109/36/123"/></identifier></author><title value="elektronische Arzneimittelverordnung"/><custodian><reference value="Organization/3c087068-3892-4fb1-81eb-75631ff61a44"/></custodian><section><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Section_Type"/><code value="Coverage"/></coding></code><entry><reference value="Coverage/895076b2-d48b-43c1-afaa-c49cf536a84a"/></entry></section><section><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Section_Type"/><code value="Prescription"/></coding></code><entry><reference value="MedicationRequest/6fac06e6-2315-41a2-8bd9-fe52aefc4d6d"/></entry></section></Composition></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/MedicationRequest/6fac06e6-2315-41a2-8bd9-fe52aefc4d6d"/><resource><MedicationRequest xmlns="http://hl7.org/fhir"><id value="6fac06e6-2315-41a2-8bd9-fe52aefc4d6d"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Prescription|1.0.2"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_BVG"><valueBoolean value="false"/></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_EmergencyServicesFee"><valueBoolean value="false"/></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Multiple_Prescription"><extension url="Kennzeichen"><valueBoolean value="false"/></extension></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_StatusCoPayment"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_StatusCoPayment"/><code value="2"/></valueCoding></extension><status value="active"/><intent value="order"/><medicationReference><reference value="Medication/8588db54-b722-4652-b30c-9f18d5a30fa0"/></medicationReference><subject><reference value="Patient/330df12e-eb14-4a92-bfc8-f54580085dda"/></subject><authoredOn value="2023-08-28"/><requester><reference value="Practitioner/ac41f1fa-5492-47a5-8da3-788896061c8b"/></requester><insurance><reference value="Coverage/f4f2f505-befc-489f-b0a2-53f4ac8d1aad"/></insurance><dosageInstruction><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DosageFlag"><valueBoolean value="true"/></extension><text value="3-0-3-1-0-2-2"/></dosageInstruction><dispenseRequest><quantity><value value="15"/><system value="http://unitsofmeasure.org"/><code value="{Package}"/></quantity></dispenseRequest><substitution><allowedBoolean value="true"/></substitution></MedicationRequest></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Medication/8588db54-b722-4652-b30c-9f18d5a30fa0"/><resource><Medication xmlns="http://hl7.org/fhir"><id value="8588db54-b722-4652-b30c-9f18d5a30fa0"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Medication_PZN|1.0.2"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Category"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Medication_Category"/><code value="00"/></valueCoding></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Vaccine"><valueBoolean value="false"/></extension><extension url="http://fhir.de/StructureDefinition/normgroesse"><valueCode value="NB"/></extension><code><coding><system value="http://fhir.de/CodeSystem/ifa/pzn"/><code value="43245652"/></coding><text value="Fenimofen"/></code><form><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DARREICHUNGSFORM"/><code value="PLD"/></coding></form><amount><numerator><value value="19"/><unit value="Stk"/></numerator><denominator><value value="1"/></denominator></amount></Medication></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Patient/d3da6235-94cf-4e1a-832c-ff0a4b631e45"/><resource><Patient xmlns="http://hl7.org/fhir"><id value="d3da6235-94cf-4e1a-832c-ff0a4b631e45"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Patient|1.0.3"/></meta><identifier><type><coding><system value="http://fhir.de/CodeSystem/identifier-type-de-basis"/><code value="GKV"/></coding></type><system value="http://fhir.de/NamingSystem/gkv/kvid-10"/><value value="X110498565"/></identifier><name><use value="official"/><family value="Hüllmann"/><given value="Sina"/></name><birthDate value="2000-01-31"/><address><type value="both"/><line value="Am Weidenbusch 9"><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber"><valueString value="9"/></extension><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName"><valueString value="Am Weidenbusch"/></extension></line><city value="Alt Jesseberg"/><postalCode value="65418"/><country value="D"/></address></Patient></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Organization/3c087068-3892-4fb1-81eb-75631ff61a44"/><resource><Organization xmlns="http://hl7.org/fhir"><id value="3c087068-3892-4fb1-81eb-75631ff61a44"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Organization|1.0.3"/></meta><identifier><type><coding><system value="http://terminology.hl7.org/CodeSystem/v2-0203"/><code value="BSNR"/></coding></type><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_Base_BSNR"/><value value="503195157"/></identifier><name value="Arztpraxis Claudius"/><telecom><system value="phone"/><value value="(0264) 067445556"/></telecom><telecom><system value="email"/><value value="fabio.helmke@schedler.de"/></telecom><address><type value="both"/><line value="Köttershof 78"><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber"><valueString value="78"/></extension><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName"><valueString value="Köttershof"/></extension></line><city value="Ost Kaan"/><postalCode value="88086"/><country value="D"/></address></Organization></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Coverage/895076b2-d48b-43c1-afaa-c49cf536a84a"/><resource><Coverage xmlns="http://hl7.org/fhir"><id value="895076b2-d48b-43c1-afaa-c49cf536a84a"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Coverage|1.0.3"/></meta><extension url="http://fhir.de/StructureDefinition/gkv/besondere-personengruppe"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_PERSONENGRUPPE"/><code value="00"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/dmp-kennzeichen"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DMP"/><code value="00"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/wop"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_ITA_WOP"/><code value="50"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/versichertenart"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_VERSICHERTENSTATUS"/><code value="1"/></valueCoding></extension><status value="active"/><type><coding><system value="http://fhir.de/CodeSystem/versicherungsart-de-basis"/><code value="GKV"/></coding></type><beneficiary><reference value="Patient/1568a3e6-45d8-4866-a4c2-7055869049c9"/></beneficiary><payor><identifier><system value="http://fhir.de/NamingSystem/arge-ik/iknr"/><value value="108833674"/></identifier><display value="BKK KBA"/></payor></Coverage></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Practitioner/ac41f1fa-5492-47a5-8da3-788896061c8b"/><resource><Practitioner xmlns="http://hl7.org/fhir"><id value="ac41f1fa-5492-47a5-8da3-788896061c8b"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Practitioner|1.0.3"/></meta><identifier><type><coding><system value="http://terminology.hl7.org/CodeSystem/v2-0203"/><code value="LANR"/></coding></type><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_Base_ANR"/><value value="272912859"/></identifier><name><use value="official"/><family value="Claudius"/><given value="Bernd"/><prefix value="Dr."><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier"><valueCode value="AC"/></extension></prefix></name><qualification><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_Qualification_Type"/><code value="00"/></coding></code></qualification><qualification><code><text value="Super-Facharzt für alles Mögliche"/></code></qualification></Practitioner></resource></entry></Bundle>
            """;

  String bundle4 =
      """
            <Bundle xmlns="http://hl7.org/fhir"><id value="8fe79a09-c757-4fca-9053-98a3356c934f"/><meta><lastUpdated value="2023-10-22T21:59:01.910+02:00"/><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Bundle|1.1.0"/></meta><identifier><system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId"/><value value="160.000.210.270.047.25"/></identifier><type value="document"/><timestamp value="2023-10-22T21:59:01.911+02:00"/><entry><fullUrl value="https://pvs.gematik.de/fhir/Composition/ae6a3004-b790-47df-b71c-952b52151a75"/><resource><Composition xmlns="http://hl7.org/fhir"><id value="ae6a3004-b790-47df-b71c-952b52151a75"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Composition|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_FOR_Legal_basis"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_STATUSKENNZEICHEN"/><code value="00"/></valueCoding></extension><status value="final"/><type><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_FORMULAR_ART"/><code value="e16A"/></coding></type><subject><reference value="Patient/de664174-f34b-457b-a9e5-fca62563c046"/></subject><date value="2023-10-22T21:59:01+02:00"/><author><reference value="Practitioner/f0b1d845-f79c-4fc5-8e14-f6db34b62ea2"/><type value="Practitioner"/></author><author><type value="Device"/><identifier><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_FOR_Pruefnummer"/><value value="GEMATIK/410/2109/36/123"/></identifier></author><title value="elektronische Arzneimittelverordnung"/><custodian><reference value="Organization/64ffd476-a90a-49cb-be8c-5ba12bd2df57"/></custodian><section><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Section_Type"/><code value="Coverage"/></coding></code><entry><reference value="Coverage/ae6cb571-5485-4052-8ecf-3d08b27b1b5b"/></entry></section><section><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Section_Type"/><code value="Prescription"/></coding></code><entry><reference value="MedicationRequest/ab7b0716-ae22-4088-b838-bf3b20a35518"/></entry></section></Composition></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Medication/9e66c8c1-450f-4d6e-9812-3b4a6aac9680"/><resource><Medication xmlns="http://hl7.org/fhir"><id value="9e66c8c1-450f-4d6e-9812-3b4a6aac9680"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Medication_PZN|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_Base_Medication_Type"><valueCodeableConcept><coding><system value="http://snomed.info/sct"/><version value="http://snomed.info/sct/900000000000207008/version/20220331"/><code value="763158003"/><display value="Medicinal product (product)"/></coding></valueCodeableConcept></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Category"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Medication_Category"/><code value="00"/></valueCoding></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Vaccine"><valueBoolean value="false"/></extension><extension url="http://fhir.de/StructureDefinition/normgroesse"><valueCode value="Sonstiges"/></extension><code><coding><system value="http://fhir.de/CodeSystem/ifa/pzn"/><code value="55670816"/></coding><text value="Homimozol"/></code><form><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DARREICHUNGSFORM"/><code value="IHP"/></coding></form><amount><numerator><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_PackagingSize"><valueString value="15"/></extension><unit value="Stk"/></numerator><denominator><value value="1"/></denominator></amount></Medication></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Patient/de664174-f34b-457b-a9e5-fca62563c046"/><resource><Patient xmlns="http://hl7.org/fhir"><id value="de664174-f34b-457b-a9e5-fca62563c046"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Patient|1.1.0"/></meta><identifier><type><coding><system value="http://fhir.de/CodeSystem/identifier-type-de-basis"/><code value="GKV"/></coding></type><system value="http://fhir.de/sid/gkv/kvid-10"/><value value="X110498565"/></identifier><name><use value="official"/><family value="Hüllmann"><extension url="http://hl7.org/fhir/StructureDefinition/humanname-own-name"><valueString value="Hüllmann"/></extension></family><given value="Sina"/></name><birthDate value="1971-08-20"/><address><type value="both"/><line value="Sudestr. 8"><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber"><valueString value="8"/></extension><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName"><valueString value="Sudestr."/></extension></line><city value="Alenadorf"/><postalCode value="74679"/><country value="D"/></address></Patient></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Organization/64ffd476-a90a-49cb-be8c-5ba12bd2df57"/><resource><Organization xmlns="http://hl7.org/fhir"><id value="64ffd476-a90a-49cb-be8c-5ba12bd2df57"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Organization|1.1.0"/></meta><identifier><type><coding><system value="http://terminology.hl7.org/CodeSystem/v2-0203"/><code value="BSNR"/></coding></type><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_Base_BSNR"/><value value="465959050"/></identifier><name value="Arztpraxis Claudius"/><telecom><system value="phone"/><value value="+49-400-8611045"/></telecom><telecom><system value="email"/><value value="judy.schnürer@gabler.org"/></telecom><address><type value="both"/><line value="Dünnwalder Grenzweg 27b"><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber"><valueString value="27b"/></extension><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName"><valueString value="Dünnwalder Grenzweg"/></extension></line><city value="Groß Calvin"/><postalCode value="43244"/><country value="D"/></address></Organization></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Coverage/ae6cb571-5485-4052-8ecf-3d08b27b1b5b"/><resource><Coverage xmlns="http://hl7.org/fhir"><id value="ae6cb571-5485-4052-8ecf-3d08b27b1b5b"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Coverage|1.1.0"/></meta><extension url="http://fhir.de/StructureDefinition/gkv/besondere-personengruppe"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_PERSONENGRUPPE"/><code value="00"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/dmp-kennzeichen"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DMP"/><code value="00"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/wop"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_ITA_WOP"/><code value="55"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/versichertenart"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_VERSICHERTENSTATUS"/><code value="1"/></valueCoding></extension><status value="active"/><type><coding><system value="http://fhir.de/CodeSystem/versicherungsart-de-basis"/><code value="GKV"/></coding></type><beneficiary><reference value="Patient/8b7abd64-3754-4cf5-a0d1-fc1cd71737e1"/></beneficiary><payor><identifier><system value="http://fhir.de/sid/arge-ik/iknr"/><value value="102429648"/></identifier><display value="BKK EWE"/></payor></Coverage></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Practitioner/f0b1d845-f79c-4fc5-8e14-f6db34b62ea2"/><resource><Practitioner xmlns="http://hl7.org/fhir"><id value="f0b1d845-f79c-4fc5-8e14-f6db34b62ea2"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Practitioner|1.1.0"/></meta><identifier><type><coding><system value="http://terminology.hl7.org/CodeSystem/v2-0203"/><code value="LANR"/></coding></type><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_Base_ANR"/><value value="579872343"/></identifier><name><use value="official"/><family value="Claudius"><extension url="http://hl7.org/fhir/StructureDefinition/humanname-own-name"><valueString value="Claudius"/></extension></family><given value="Bernd"/><prefix value="Dr."><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier"><valueCode value="AC"/></extension></prefix></name><qualification><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_Qualification_Type"/><code value="00"/></coding></code></qualification><qualification><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_Berufsbezeichnung"/><code value="Berufsbezeichnung"/></coding><text value="Super-Facharzt für alles Mögliche"/></code></qualification></Practitioner></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/MedicationRequest/ab7b0716-ae22-4088-b838-bf3b20a35518"/><resource><MedicationRequest xmlns="http://hl7.org/fhir"><id value="ab7b0716-ae22-4088-b838-bf3b20a35518"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Prescription|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_BVG"><valueBoolean value="false"/></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_EmergencyServicesFee"><valueBoolean value="false"/></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Multiple_Prescription"><extension url="Kennzeichen"><valueBoolean value="false"/></extension></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_FOR_StatusCoPayment"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_StatusCoPayment"/><code value="2"/></valueCoding></extension><status value="active"/><intent value="order"/><medicationReference><reference value="Medication/9e66c8c1-450f-4d6e-9812-3b4a6aac9680"/></medicationReference><subject><reference value="Patient/6fb0a370-16b0-4d92-a09f-55ba446b59c0"/></subject><authoredOn value="2023-10-22"/><requester><reference value="Practitioner/dc3b4952-0c8e-4b3c-b5fc-5aac1e914d97"/></requester><insurance><reference value="Coverage/82799c6e-9d0e-4d31-86db-853c5a78be0a"/></insurance><dosageInstruction><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DosageFlag"><valueBoolean value="true"/></extension><text value="3-3-2-2-2-1"/></dosageInstruction><dispenseRequest><quantity><value value="15"/><system value="http://unitsofmeasure.org"/><code value="{Package}"/></quantity></dispenseRequest><substitution><allowedBoolean value="true"/></substitution></MedicationRequest></resource></entry></Bundle>
    """;

  LinkedList<String> bundleList = new LinkedList();

  /*  @BeforeAll
      static void setup() {
          fhirParser = new FhirParser();
      }
  */
  @SneakyThrows
  @SuppressWarnings("java:S6300")
  public static void writeStringUsingBufferedWriter(String bundle, Path dir, String fileName) {
    try (BufferedWriter writer =
        new BufferedWriter(
            new FileWriter(Path.of(dir.toAbsolutePath().toString(), fileName).toFile()))) {
      writer.write(bundle);
    }
  }

  @BeforeEach
  void prepareTestList() {
    /* bundleList.add(bundle3);
    bundleList.add(stringBundle2);
    bundleList.add(stringBundleXml);*/
    /*bundleList.add("""
               <Bundle xmlns="http://hl7.org/fhir"><id value="93785de1-3cda-46d8-85bc-2a599e6f2a4c"/><meta><lastUpdated value="2023-08-30T13:59:39.174+02:00"/><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Bundle|1.1.0"/></meta><identifier><system value="https://gematik.de/fhir/erp/NamingSystem/GEM_ERP_NS_PrescriptionId"/><value value="160.000.210.181.854.85"/></identifier><type value="document"/><timestamp value="2023-08-30T13:59:39.174+02:00"/><entry><fullUrl value="https://pvs.gematik.de/fhir/Composition/57eaa8f6-4283-4521-8003-2ee7313ba4ef"/><resource><Composition xmlns="http://hl7.org/fhir"><id value="57eaa8f6-4283-4521-8003-2ee7313ba4ef"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Composition|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_FOR_Legal_basis"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_STATUSKENNZEICHEN"/><code value="00"/></valueCoding></extension><status value="final"/><type><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_FORMULAR_ART"/><code value="e16A"/></coding></type><subject><reference value="Patient/f1940903-86c9-4751-91f8-e8d416167a63"/></subject><date value="2023-08-30T13:59:39+02:00"/><author><reference value="Practitioner/56083fb1-1b23-4965-b06a-afae88ac3da8"/><type value="Practitioner"/></author><author><type value="Device"/><identifier><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_FOR_Pruefnummer"/><value value="GEMATIK/410/2109/36/123"/></identifier></author><title value="elektronische Arzneimittelverordnung"/><custodian><reference value="Organization/3a0f081b-c68f-4945-85b2-e8773b9e9465"/></custodian><section><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Section_Type"/><code value="Coverage"/></coding></code><entry><reference value="Coverage/25c0ee5c-fd60-4aff-9ccd-3fd710810465"/></entry></section><section><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Section_Type"/><code value="Prescription"/></coding></code><entry><reference value="MedicationRequest/c9723153-3e97-400e-bbb3-3fab99e50658"/></entry></section></Composition></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/MedicationRequest/c9723153-3e97-400e-bbb3-3fab99e50658"/><resource><MedicationRequest xmlns="http://hl7.org/fhir"><id value="c9723153-3e97-400e-bbb3-3fab99e50658"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Prescription|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_BVG"><valueBoolean value="false"/></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_EmergencyServicesFee"><valueBoolean value="false"/></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Multiple_Prescription"><extension url="Kennzeichen"><valueBoolean value="false"/></extension></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_FOR_StatusCoPayment"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_StatusCoPayment"/><code value="1"/></valueCoding></extension><status value="active"/><intent value="order"/><medicationReference><reference value="Medication/11cbb79e-abd2-4591-a1bd-5e9b74ed4a0a"/></medicationReference><subject><reference value="Patient/a1ea7d0d-7030-48de-96db-7e6f2d208eb3"/></subject><authoredOn value="2023-08-30"/><requester><reference value="Practitioner/56083fb1-1b23-4965-b06a-afae88ac3da8"/></requester><insurance><reference value="Coverage/a3c6b822-04e8-412a-816d-49fcda26d29b"/></insurance><dosageInstruction><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DosageFlag"><valueBoolean value="true"/></extension><text value="3-2-0-0-3"/></dosageInstruction><dispenseRequest><quantity><value value="4"/><system value="http://unitsofmeasure.org"/><code value="{Package}"/></quantity></dispenseRequest><substitution><allowedBoolean value="false"/></substitution></MedicationRequest></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Medication/11cbb79e-abd2-4591-a1bd-5e9b74ed4a0a"/><resource><Medication xmlns="http://hl7.org/fhir"><id value="11cbb79e-abd2-4591-a1bd-5e9b74ed4a0a"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Medication_PZN|1.1.0"/></meta><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_Base_Medication_Type"><valueCodeableConcept><coding><system value="http://snomed.info/sct"/><version value="http://snomed.info/sct/900000000000207008/version/20220331"/><code value="763158003"/><display value="Medicinal product (product)"/></coding></valueCodeableConcept></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Category"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_ERP_Medication_Category"/><code value="00"/></valueCoding></extension><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Vaccine"><valueBoolean value="false"/></extension><extension url="http://fhir.de/StructureDefinition/normgroesse"><valueCode value="N2"/></extension><code><coding><system value="http://fhir.de/CodeSystem/ifa/pzn"/><code value="63051865"/></coding><text value="Amovomilnat"/></code><form><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DARREICHUNGSFORM"/><code value="PIV"/></coding></form><amount><numerator><extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_PackagingSize"><valueString value="2"/></extension><unit value="Stk"/></numerator><denominator><value value="1"/></denominator></amount></Medication></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Patient/f1940903-86c9-4751-91f8-e8d416167a63"/><resource><Patient xmlns="http://hl7.org/fhir"><id value="f1940903-86c9-4751-91f8-e8d416167a63"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Patient|1.1.0"/></meta><identifier><type><coding><system value="http://fhir.de/CodeSystem/identifier-type-de-basis"/><code value="GKV"/></coding></type><system value="http://fhir.de/sid/gkv/kvid-10"/><value value="X110498565"/></identifier><name><use value="official"/><family value="Hüllmann"><extension url="http://hl7.org/fhir/StructureDefinition/humanname-own-name"><valueString value="Hüllmann"/></extension></family><given value="Sina"/></name><birthDate value="1977-11-20"/><address><type value="both"/><line value="Rheinallee 51"><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber"><valueString value="51"/></extension><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName"><valueString value="Rheinallee"/></extension></line><city value="Ellihagen"/><postalCode value="68391"/><country value="D"/></address></Patient></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Organization/3a0f081b-c68f-4945-85b2-e8773b9e9465"/><resource><Organization xmlns="http://hl7.org/fhir"><id value="3a0f081b-c68f-4945-85b2-e8773b9e9465"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Organization|1.1.0"/></meta><identifier><type><coding><system value="http://terminology.hl7.org/CodeSystem/v2-0203"/><code value="BSNR"/></coding></type><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_Base_BSNR"/><value value="039724162"/></identifier><name value="Arztpraxis Claudius"/><telecom><system value="phone"/><value value="(0195) 225499415"/></telecom><telecom><system value="email"/><value value="azra.bichler@christ.de"/></telecom><address><type value="both"/><line value="Adolf-Baeyer-Str. 294"><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber"><valueString value="294"/></extension><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName"><valueString value="Adolf-Baeyer-Str."/></extension></line><city value="Romandorf"/><postalCode value="68762"/><country value="D"/></address></Organization></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Coverage/25c0ee5c-fd60-4aff-9ccd-3fd710810465"/><resource><Coverage xmlns="http://hl7.org/fhir"><id value="25c0ee5c-fd60-4aff-9ccd-3fd710810465"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Coverage|1.1.0"/></meta><extension url="http://fhir.de/StructureDefinition/gkv/besondere-personengruppe"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_PERSONENGRUPPE"/><code value="00"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/dmp-kennzeichen"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DMP"/><code value="00"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/wop"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_ITA_WOP"/><code value="48"/></valueCoding></extension><extension url="http://fhir.de/StructureDefinition/gkv/versichertenart"><valueCoding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_VERSICHERTENSTATUS"/><code value="1"/></valueCoding></extension><status value="active"/><type><coding><system value="http://fhir.de/CodeSystem/versicherungsart-de-basis"/><code value="GKV"/></coding></type><beneficiary><reference value="Patient/78088119-8cd8-4f6a-b0c7-b06b2143e42b"/></beneficiary><payor><identifier><system value="http://fhir.de/sid/arge-ik/iknr"/><value value="101575519"/></identifier><display value="Techniker Krankenkasse"/></payor></Coverage></resource></entry><entry><fullUrl value="https://pvs.gematik.de/fhir/Practitioner/56083fb1-1b23-4965-b06a-afae88ac3da8"/><resource><Practitioner xmlns="http://hl7.org/fhir"><id value="56083fb1-1b23-4965-b06a-afae88ac3da8"/><meta><profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_FOR_Practitioner|1.1.0"/></meta><identifier><type><coding><system value="http://terminology.hl7.org/CodeSystem/v2-0203"/><code value="LANR"/></coding></type><system value="https://fhir.kbv.de/NamingSystem/KBV_NS_Base_ANR"/><value value="977476544"/></identifier><name><use value="official"/><family value="Claudius"><extension url="http://hl7.org/fhir/StructureDefinition/humanname-own-name"><valueString value="Claudius"/></extension></family><given value="Bernd"/><prefix value="Dr."><extension url="http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier"><valueCode value="AC"/></extension></prefix></name><qualification><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_Qualification_Type"/><code value="00"/></coding></code></qualification><qualification><code><coding><system value="https://fhir.kbv.de/CodeSystem/KBV_CS_FOR_Berufsbezeichnung"/><code value="Berufsbezeichnung"/></coding><text value="Super-Facharzt für alles Mögliche"/></code></qualification></Practitioner></resource></entry></Bundle>
    */
  }

  @Test
  void shouldValidateOne() {
    /*val bundle2 = parser.decode(
    ErxReceipt.class,
    ResourceUtils.readFileFromResource(
            "fhir/valid/kbv/1.1.0/bundle/5a3458b0-8364-4682-96e2-b262b2ab16eb.xml"));*/
    val bundle = parser.decode(KbvErpBundle.class, stringBundle2);
    val result = ValidatorUtil.encodeAndValidate(parser, bundle, EncodingType.XML, true, true);
    System.out.println(result.getMessages());
  }

  @Test
  void shouldValidate() {
    counter = 0;
    try {
      for (val s : bundleList) {
        getBundleFromXML(s);
      }
      bundleList.add(stringBundle2);
    } catch (IllegalArgumentException e) {
      log.info("reason for IllegalArgumentException: " + e);
    }

    val bundle = parser.decode(stringBundle2, EncodingType.XML);
    val result = ValidatorUtil.encodeAndValidate(parser, bundle);

    val emptyTargetDir = Path.of(System.getProperty("user.dir"), "target", "tmp", "out");
    emptyTargetDir.toFile().mkdirs();
    log.info("Counter for invalid Bundles --------- >>> : " + counter);
    if (counter > 0) {
      int counter2Save = 0;
      for (val b : invalidBundleList) {
        counter2Save++;
        writeStringUsingBufferedWriter(
            b, emptyTargetDir, format("Run_{0}_xmlFuzzedBundle{1}.xml", counter2Save, false));
      }
    }
  }

  private void getBundleFromXML(String stringXMLBundle) throws IllegalArgumentException {
    Bundle bundle;
    if (stringXMLBundle == null || stringXMLBundle.length() < 5) {
      throw new IllegalArgumentException("given XML String is no valid Bundle");
    } else if (!parser.isValid(stringXMLBundle)) {
      val validResult = parser.validate(stringXMLBundle);
      if (!validResult.isSuccessful()) {
        log.info(validResult.toString());
        invalidBundleList.add(stringXMLBundle);
        counter++;
      }
    }
  }
}
