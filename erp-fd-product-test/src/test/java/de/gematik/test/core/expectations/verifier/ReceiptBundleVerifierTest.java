/*
 * Copyright 2025 gematik GmbH
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * *******
 *
 * For additional notes and disclaimer from gematik and in case of changes by gematik find details in the "Readme" file.
 */

package de.gematik.test.core.expectations.verifier;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.jupiter.api.Assertions.*;

import de.gematik.bbriccs.utils.PrivateConstructorsUtil;
import de.gematik.bbriccs.utils.ResourceLoader;
import de.gematik.test.core.expectations.requirements.CoverageReporter;
import de.gematik.test.core.expectations.requirements.ErpAfos;
import de.gematik.test.erezept.fhir.r4.erp.ErxReceipt;
import de.gematik.test.erezept.fhir.testutil.ErpFhirParsingTest;
import java.util.Base64;
import lombok.val;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

class ReceiptBundleVerifierTest extends ErpFhirParsingTest {

  private static final String NEW_RECEIPT_VERSION =
      "fhir/valid/erp/1.4.0/receiptbundle/fdResponse.xml";
  private static final String INVALID_RECEIPT_BUNDLE =
      "fhir/invalid/erp/1.4.0/dffbfd6a-5712-4798-bdc8-07201eb77ab8_manipulated_references.json";

  @BeforeEach
  void init() {
    CoverageReporter.getInstance().startTestcase("not needed");
  }

  @Test
  void shouldNotInstantiateUtilityClass() {
    assertTrue(PrivateConstructorsUtil.isUtilityConstructor(ReceiptBundleVerifier.class));
  }

  @Test
  void shouldPassOnValidReceipt() {
    val bundle =
        parser.decode(ErxReceipt.class, ResourceLoader.readFileFromResource(NEW_RECEIPT_VERSION));
    val step = ReceiptBundleVerifier.entryFullUrlIsUuid();
    step.apply(bundle);
  }

  @Test
  void shouldFailOnInvalidReceiptEntryFullUrl() {
    val invalidReceipt =
        parser.decode(
            ErxReceipt.class, ResourceLoader.readFileFromResource(INVALID_RECEIPT_BUNDLE));

    val step = ReceiptBundleVerifier.entryFullUrlIsUuid();
    assertThrows(AssertionError.class, () -> step.apply(invalidReceipt));
  }

  @Test
  void shouldFailOnInvalidReceiptEntryCompAuthorReference() {
    val bundle =
        parser.decode(
            ErxReceipt.class, ResourceLoader.readFileFromResource(INVALID_RECEIPT_BUNDLE));
    bundle.getAuthor().setReference("123Test");
    val step = ReceiptBundleVerifier.compAuthorRefIsUuid();
    assertThrows(AssertionError.class, () -> step.apply(bundle));
  }

  @Test
  void shouldFailOnInvalidReceiptEntrySignatureRef() {
    val bundle =
        parser.decode(
            ErxReceipt.class, ResourceLoader.readFileFromResource(INVALID_RECEIPT_BUNDLE));
    bundle.getSignature().getWho().setReference("123Test");
    val step = ReceiptBundleVerifier.signatureRefIsUuid();
    assertThrows(AssertionError.class, () -> step.apply(bundle));
  }

  @Test
  void shouldFailOnInvalidReceiptEntryCompSectionRef() {
    val bundle =
        parser.decode(
            ErxReceipt.class, ResourceLoader.readFileFromResource(INVALID_RECEIPT_BUNDLE));

    bundle.getQesDigestRefInComposSect().getEntryFirstRep().setReference("123Test");
    val step = ReceiptBundleVerifier.compSectionRefIsUuid();

    assertThrows(AssertionError.class, () -> step.apply(bundle));
  }

  @Test
  void referenceValidationShouldPassOnValidReceipt() {
    val bundle =
        parser.decode(ErxReceipt.class, ResourceLoader.readFileFromResource(NEW_RECEIPT_VERSION));

    val step = ReceiptBundleVerifier.compAuthorRefIsUuid();
    step.apply(bundle);
    val step2 = ReceiptBundleVerifier.compSectionRefIsUuid();
    step2.apply(bundle);
    val step3 = ReceiptBundleVerifier.signatureRefIsUuid();
    step3.apply(bundle);
  }

  @Test
  void shouldGetBinary() {
    val bundle =
        parser.decode(
            ErxReceipt.class,
            ResourceLoader.readFileFromResource(
                "fhir/invalid/erp/1.4.0/dffbfd6a-5712-4798-bdc8-07201eb77ab8_manipulated_references.json"));
    val binary = bundle.getQesDigestBinary();
    val code = binary.getContentElement().getValueAsString();
    assertEquals("tJg8c5ZtdhzEEhJ0ZpAsUVFx5dKuYgQFs5oKgthi17M=", code);
  }

  private static final String SIGNED_DOC_AS_BASE64 =
      "MIAGCSqGSIb3DQEHAqCAMIACAQExDTALBglghkgBZQMEAgEwgAYJKoZIhvcNAQcBoIAkgASCA+g8QnVuZGxlIHhtbG5zPSJodHRwOi8vaGw3Lm9yZy9maGlyIj48aWQgdmFsdWU9IjM0ODhjNTNhLTAzNTItNGU4Ni1hNGU0LWNhMGQ4YzJlYWEyYyIvPjxtZXRhPjxwcm9maWxlIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX1BSX0VSUF9CdW5kbGV8MS4xLjAiLz48L21ldGE+PGlkZW50aWZpZXI+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9nZW1hdGlrLmRlL2ZoaXIvZXJwL05hbWluZ1N5c3RlbS9HRU1fRVJQX05TX1ByZXNjcmlwdGlvbklkIi8+PHZhbHVlIHZhbHVlPSIxNjAuMDAwLjAwNi45OTUuMTE3Ljc0Ii8+PC9pZGVudGlmaWVyPjx0eXBlIHZhbHVlPSJkb2N1bWVudCIvPjx0aW1lc3RhbXAgdmFsdWU9IjIwMjUtMDYtMjVUMTI6MzA6NTYuNzE2KzAyOjAwIi8+PGVudHJ5PjxmdWxsVXJsIHZhbHVlPSJodHRwczovL3B2cy5nZW1hdGlrLmRlL2ZoaXIvQ29tcG9zaXRpb24vMDc5ODkyNmQtYjdmZi00ZjBmLWFiZjgtNDE3YzBkNTM0MDg4Ii8+PHJlc291cmNlPjxDb21wb3NpdGlvbiB4bWxucz0iaHR0cDovL2hsNy5vcmcvZmhpciI+PGlkIHZhbHVlPSIwNzk4OTI2ZC1iN2ZmLTRmMGYtYWJmOC00MTdjMGQ1MzQwODgiLz48bWV0YT48cHJvZmlsZSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9QUl9FUlBfQ29tcG9zaXRpb258MS4xLjAiLz48L21ldGE+PGV4dGVuc2lvbiB1cmw9Imh0dHBzOi8vZmhpci5rYnYuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9LQlZfRVhfRk9SX0xlZ2FsX2Jhc2lzIj48dmFsdWVDb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9Db2RlU3lzdGVtL0tCVl9DU19TRkhJUl9LQlZfU1RBVFVTS0VOTlpFSUNIRU4iLz48Y29kZSB2YWx1ZT0iMDAiLz48L3ZhbHVlQ29kaW5nPjwvZXh0ZW5zaW9uPjxzdGF0dXMgdmFsdWU9ImZpbmFsIi8+PHR5cGU+PGNvZGluZz48c3lzdGVtIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL0NvBIID6GRlU3lzdGVtL0tCVl9DU19TRkhJUl9LQlZfRk9STVVMQVJfQVJUIi8+PGNvZGUgdmFsdWU9ImUxNkEiLz48L2NvZGluZz48L3R5cGU+PHN1YmplY3Q+PHJlZmVyZW5jZSB2YWx1ZT0iUGF0aWVudC9lZmYyYmFhYS0zOWVmLTQyZWMtYjI3MC0wNWQyZmYxNzc4MWMiLz48L3N1YmplY3Q+PGRhdGUgdmFsdWU9IjIwMjUtMDYtMjVUMTI6MzA6NTYrMDI6MDAiLz48YXV0aG9yPjx0eXBlIHZhbHVlPSJEZXZpY2UiLz48aWRlbnRpZmllcj48c3lzdGVtIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL05hbWluZ1N5c3RlbS9LQlZfTlNfRk9SX1BydWVmbnVtbWVyIi8+PHZhbHVlIHZhbHVlPSJHRU1BVElLLzQxMC8yMTA5LzM2LzEyMyIvPjwvaWRlbnRpZmllcj48L2F1dGhvcj48YXV0aG9yPjxyZWZlcmVuY2UgdmFsdWU9IlByYWN0aXRpb25lci8yMjg4OGY1Ny1iNjhjLTQ1NDQtOWI0Yi0yYTZlMWM5NDQ5NDIiLz48dHlwZSB2YWx1ZT0iUHJhY3RpdGlvbmVyIi8+PC9hdXRob3I+PHRpdGxlIHZhbHVlPSJlbGVrdHJvbmlzY2hlIEFyem5laW1pdHRlbHZlcm9yZG51bmciLz48Y3VzdG9kaWFuPjxyZWZlcmVuY2UgdmFsdWU9Ik9yZ2FuaXphdGlvbi9hYmFhMDAwOS02YWNmLTQwODYtYjI5Yy0zNGM4MmIwYzNkY2IiLz48L2N1c3RvZGlhbj48c2VjdGlvbj48Y29kZT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfRVJQX1NlY3Rpb25fVHlwZSIvPjxjb2RlIHZhbHVlPSJDb3ZlcmFnZSIvPjwvY29kaW5nPjwvY29kZT48ZW50cnk+PHJlZmVyZW5jZSB2YWx1ZT0iQ292ZXJhZ2UvMTE1NzJjMmUtMjkyNC00OWQ1LWEyNWQtZjQzMDI5YzE5ZTZjIi8+PC9lbnRyeT48L3NlY3Rpb24+PHNlY3Rpb24+PGNvZGU+PGNvZGluZz48c3lzdGVtIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL0NvZGVTeXN0ZW0vS0JWX0NTX0VSUF9TZWN0aW9uX1R5cGUiLz48Y29kZSB2YWx1ZT0iUHJlc2NyaXB0aW9uIi8+PC9jb2Rpbmc+PC8EggPoY29kZT48ZW50cnk+PHJlZmVyZW5jZSB2YWx1ZT0iTWVkaWNhdGlvblJlcXVlc3QvZGUyM2JlM2MtYjIyNi00OGU3LWJlYzUtYzE4YmJkMWI3MzdmIi8+PC9lbnRyeT48L3NlY3Rpb24+PC9Db21wb3NpdGlvbj48L3Jlc291cmNlPjwvZW50cnk+PGVudHJ5PjxmdWxsVXJsIHZhbHVlPSJodHRwczovL3B2cy5nZW1hdGlrLmRlL2ZoaXIvQ292ZXJhZ2UvMTE1NzJjMmUtMjkyNC00OWQ1LWEyNWQtZjQzMDI5YzE5ZTZjIi8+PHJlc291cmNlPjxDb3ZlcmFnZSB4bWxucz0iaHR0cDovL2hsNy5vcmcvZmhpciI+PGlkIHZhbHVlPSIxMTU3MmMyZS0yOTI0LTQ5ZDUtYTI1ZC1mNDMwMjljMTllNmMiLz48bWV0YT48cHJvZmlsZSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9QUl9GT1JfQ292ZXJhZ2V8MS4xLjAiLz48L21ldGE+PGV4dGVuc2lvbiB1cmw9Imh0dHA6Ly9maGlyLmRlL1N0cnVjdHVyZURlZmluaXRpb24vZ2t2L2Jlc29uZGVyZS1wZXJzb25lbmdydXBwZSI+PHZhbHVlQ29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfU0ZISVJfS0JWX1BFUlNPTkVOR1JVUFBFIi8+PGNvZGUgdmFsdWU9IjAwIi8+PC92YWx1ZUNvZGluZz48L2V4dGVuc2lvbj48ZXh0ZW5zaW9uIHVybD0iaHR0cDovL2ZoaXIuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9na3YvZG1wLWtlbm56ZWljaGVuIj48dmFsdWVDb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9Db2RlU3lzdGVtL0tCVl9DU19TRkhJUl9LQlZfRE1QIi8+PGNvZGUgdmFsdWU9IjAwIi8+PC92YWx1ZUNvZGluZz48L2V4dGVuc2lvbj48ZXh0ZW5zaW9uIHVybD0iaHR0cDovL2ZoaXIuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9na3Yvd29wIj48dmFsdWVDb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9Db2RlU3lzdGVtL0tCVl9DU19TRkhJUl9JVEFfV09QIi8+PGNvZGUgdmFsdQSCA+hlPSIwMSIvPjwvdmFsdWVDb2Rpbmc+PC9leHRlbnNpb24+PGV4dGVuc2lvbiB1cmw9Imh0dHA6Ly9maGlyLmRlL1N0cnVjdHVyZURlZmluaXRpb24vZ2t2L3ZlcnNpY2hlcnRlbmFydCI+PHZhbHVlQ29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfU0ZISVJfS0JWX1ZFUlNJQ0hFUlRFTlNUQVRVUyIvPjxjb2RlIHZhbHVlPSIxIi8+PC92YWx1ZUNvZGluZz48L2V4dGVuc2lvbj48c3RhdHVzIHZhbHVlPSJhY3RpdmUiLz48dHlwZT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHA6Ly9maGlyLmRlL0NvZGVTeXN0ZW0vdmVyc2ljaGVydW5nc2FydC1kZS1iYXNpcyIvPjxjb2RlIHZhbHVlPSJHS1YiLz48L2NvZGluZz48L3R5cGU+PGJlbmVmaWNpYXJ5PjxyZWZlcmVuY2UgdmFsdWU9IlBhdGllbnQvMTQ2MWUwNjgtZTUyMC00N2M4LWI4YjYtNDA5NmYzODUxMTE0Ii8+PC9iZW5lZmljaWFyeT48cGF5b3I+PGlkZW50aWZpZXI+PHN5c3RlbSB2YWx1ZT0iaHR0cDovL2ZoaXIuZGUvc2lkL2FyZ2UtaWsvaWtuciIvPjx2YWx1ZSB2YWx1ZT0iMTA4MDM2NDQxIi8+PC9pZGVudGlmaWVyPjxkaXNwbGF5IHZhbHVlPSJXTUYgQktLIi8+PC9wYXlvcj48L0NvdmVyYWdlPjwvcmVzb3VyY2U+PC9lbnRyeT48ZW50cnk+PGZ1bGxVcmwgdmFsdWU9Imh0dHBzOi8vcHZzLmdlbWF0aWsuZGUvZmhpci9QYXRpZW50L2VmZjJiYWFhLTM5ZWYtNDJlYy1iMjcwLTA1ZDJmZjE3NzgxYyIvPjxyZXNvdXJjZT48UGF0aWVudCB4bWxucz0iaHR0cDovL2hsNy5vcmcvZmhpciI+PGlkIHZhbHVlPSJlZmYyYmFhYS0zOWVmLTQyZWMtYjI3MC0wNWQyZmYxNzc4MWMiLz48bWV0YT48cHJvZmlsZSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9QUl9GT1JfUGF0aWVudHwxLjEuMCIvPjwvbWV0YT48aWRlbnRpZmllcj48dHlwZT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHA6Ly9maGlyLmRlL0NvBIID6GRlU3lzdGVtL2lkZW50aWZpZXItdHlwZS1kZS1iYXNpcyIvPjxjb2RlIHZhbHVlPSJHS1YiLz48L2NvZGluZz48L3R5cGU+PHN5c3RlbSB2YWx1ZT0iaHR0cDovL2ZoaXIuZGUvc2lkL2drdi9rdmlkLTEwIi8+PHZhbHVlIHZhbHVlPSJYMTEwNjE0MjMzIi8+PC9pZGVudGlmaWVyPjxuYW1lPjx1c2UgdmFsdWU9Im9mZmljaWFsIi8+PGZhbWlseSB2YWx1ZT0iSMO8bGxtYW5uIj48ZXh0ZW5zaW9uIHVybD0iaHR0cDovL2hsNy5vcmcvZmhpci9TdHJ1Y3R1cmVEZWZpbml0aW9uL2h1bWFubmFtZS1vd24tbmFtZSI+PHZhbHVlU3RyaW5nIHZhbHVlPSJIw7xsbG1hbm4iLz48L2V4dGVuc2lvbj48L2ZhbWlseT48Z2l2ZW4gdmFsdWU9IlNpbmEiLz48L25hbWU+PGJpcnRoRGF0ZSB2YWx1ZT0iMTk4Mi0wMS0yOCIvPjxhZGRyZXNzPjx0eXBlIHZhbHVlPSJib3RoIi8+PGxpbmUgdmFsdWU9IkFtIEjDtmxsZXJzIEVjayA1M2MiPjxleHRlbnNpb24gdXJsPSJodHRwOi8vaGw3Lm9yZy9maGlyL1N0cnVjdHVyZURlZmluaXRpb24vaXNvMjEwOTAtQURYUC1ob3VzZU51bWJlciI+PHZhbHVlU3RyaW5nIHZhbHVlPSI1M2MiLz48L2V4dGVuc2lvbj48ZXh0ZW5zaW9uIHVybD0iaHR0cDovL2hsNy5vcmcvZmhpci9TdHJ1Y3R1cmVEZWZpbml0aW9uL2lzbzIxMDkwLUFEWFAtc3RyZWV0TmFtZSI+PHZhbHVlU3RyaW5nIHZhbHVlPSJBbSBIw7ZsbGVycyBFY2siLz48L2V4dGVuc2lvbj48L2xpbmU+PGNpdHkgdmFsdWU9IkpvbGllYmVyZyIvPjxwb3N0YWxDb2RlIHZhbHVlPSI4MjM2NCIvPjxjb3VudHJ5IHZhbHVlPSJEIi8+PC9hZGRyZXNzPjwvUGF0aWVudD48L3Jlc291cmNlPjwvZW50cnk+PGVudHJ5PjxmdWxsVXJsIHZhbHVlPSJodHRwczovL3B2cy5nZW1hdGlrLmRlL2ZoaXIvUHJhY3RpdGlvbmVyLzIyODg4ZjU3LWI2OGMtNDU0NC05YjRiLTJhNmUxYzk0NDk0MiIvPjxyZXNvdXJjZT48UHJhY3RpdGlvbmVyIHhtbG5zPSJodHRwOi8vaGw3Lm9yZy9maGlyIj48aWQgdmFsdWUEggPoPSIyMjg4OGY1Ny1iNjhjLTQ1NDQtOWI0Yi0yYTZlMWM5NDQ5NDIiLz48bWV0YT48cHJvZmlsZSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9QUl9GT1JfUHJhY3RpdGlvbmVyfDEuMS4wIi8+PC9tZXRhPjxpZGVudGlmaWVyPjx0eXBlPjxjb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cDovL3Rlcm1pbm9sb2d5LmhsNy5vcmcvQ29kZVN5c3RlbS92Mi0wMjAzIi8+PGNvZGUgdmFsdWU9IkxBTlIiLz48L2NvZGluZz48L3R5cGU+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9OYW1pbmdTeXN0ZW0vS0JWX05TX0Jhc2VfQU5SIi8+PHZhbHVlIHZhbHVlPSI3MTcyNzY1OTAiLz48L2lkZW50aWZpZXI+PG5hbWU+PHVzZSB2YWx1ZT0ib2ZmaWNpYWwiLz48ZmFtaWx5IHZhbHVlPSJVbG1lbndhbGQiPjxleHRlbnNpb24gdXJsPSJodHRwOi8vaGw3Lm9yZy9maGlyL1N0cnVjdHVyZURlZmluaXRpb24vaHVtYW5uYW1lLW93bi1uYW1lIj48dmFsdWVTdHJpbmcgdmFsdWU9IlVsbWVud2FsZCIvPjwvZXh0ZW5zaW9uPjwvZmFtaWx5PjxnaXZlbiB2YWx1ZT0iQWRlbGhlaWQiLz48cHJlZml4IHZhbHVlPSJEci4iPjxleHRlbnNpb24gdXJsPSJodHRwOi8vaGw3Lm9yZy9maGlyL1N0cnVjdHVyZURlZmluaXRpb24vaXNvMjEwOTAtRU4tcXVhbGlmaWVyIj48dmFsdWVDb2RlIHZhbHVlPSJBQyIvPjwvZXh0ZW5zaW9uPjwvcHJlZml4PjwvbmFtZT48cXVhbGlmaWNhdGlvbj48Y29kZT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfRk9SX1F1YWxpZmljYXRpb25fVHlwZSIvPjxjb2RlIHZhbHVlPSIwMCIvPjwvY29kaW5nPjwvY29kZT48L3F1YWxpZmljYXRpb24+PHF1YWxpZmljYXRpb24+PGNvZGU+PGNvZGluZz48c3lzdGVtIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL0NvZGVTeXN0ZW0vS0JWX0NTX0ZPUl9CZXJ1ZnNiZXplaWNobnVuZyIvPjxjb2RlIASCA+h2YWx1ZT0iQmVydWZzYmV6ZWljaG51bmciLz48L2NvZGluZz48dGV4dCB2YWx1ZT0iU3VwZXItRmFjaGFyenQgZsO8ciBhbGxlcyBNw7ZnbGljaGUiLz48L2NvZGU+PC9xdWFsaWZpY2F0aW9uPjwvUHJhY3RpdGlvbmVyPjwvcmVzb3VyY2U+PC9lbnRyeT48ZW50cnk+PGZ1bGxVcmwgdmFsdWU9Imh0dHBzOi8vcHZzLmdlbWF0aWsuZGUvZmhpci9Pcmdhbml6YXRpb24vYWJhYTAwMDktNmFjZi00MDg2LWIyOWMtMzRjODJiMGMzZGNiIi8+PHJlc291cmNlPjxPcmdhbml6YXRpb24geG1sbnM9Imh0dHA6Ly9obDcub3JnL2ZoaXIiPjxpZCB2YWx1ZT0iYWJhYTAwMDktNmFjZi00MDg2LWIyOWMtMzRjODJiMGMzZGNiIi8+PG1ldGE+PHByb2ZpbGUgdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9LQlZfUFJfRk9SX09yZ2FuaXphdGlvbnwxLjEuMCIvPjwvbWV0YT48aWRlbnRpZmllcj48dHlwZT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHA6Ly90ZXJtaW5vbG9neS5obDcub3JnL0NvZGVTeXN0ZW0vdjItMDIwMyIvPjxjb2RlIHZhbHVlPSJCU05SIi8+PC9jb2Rpbmc+PC90eXBlPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvTmFtaW5nU3lzdGVtL0tCVl9OU19CYXNlX0JTTlIiLz48dmFsdWUgdmFsdWU9IjAzNDE3OTQyNSIvPjwvaWRlbnRpZmllcj48bmFtZSB2YWx1ZT0iQXJ6dHByYXhpcyBVbG1lbndhbGQiLz48dGVsZWNvbT48c3lzdGVtIHZhbHVlPSJwaG9uZSIvPjx2YWx1ZSB2YWx1ZT0iKzQ5LTczMi0wNDE2MjM2Ii8+PC90ZWxlY29tPjx0ZWxlY29tPjxzeXN0ZW0gdmFsdWU9ImVtYWlsIi8+PHZhbHVlIHZhbHVlPSJheWxlZW4uZGFobUBtYWlzY2gubmFtZSIvPjwvdGVsZWNvbT48YWRkcmVzcz48dHlwZSB2YWx1ZT0iYm90aCIvPjxsaW5lIHZhbHVlPSJEZWljaHRvcnN0ci4gMTFiIj48ZXh0ZW5zaW9uIHVybD0iaHR0cDovL2hsNy5vcmcvZmhpci9TdHJ1Y3R1cmVEZWZpbml0aW9uL2lzbzIxMDkwLUFEBIID6FhQLWhvdXNlTnVtYmVyIj48dmFsdWVTdHJpbmcgdmFsdWU9IjExYiIvPjwvZXh0ZW5zaW9uPjxleHRlbnNpb24gdXJsPSJodHRwOi8vaGw3Lm9yZy9maGlyL1N0cnVjdHVyZURlZmluaXRpb24vaXNvMjEwOTAtQURYUC1zdHJlZXROYW1lIj48dmFsdWVTdHJpbmcgdmFsdWU9IkRlaWNodG9yc3RyLiIvPjwvZXh0ZW5zaW9uPjwvbGluZT48Y2l0eSB2YWx1ZT0iTmV1IE1lbGlzYXN0YWR0Ii8+PHBvc3RhbENvZGUgdmFsdWU9IjkyMTUwIi8+PGNvdW50cnkgdmFsdWU9IkQiLz48L2FkZHJlc3M+PC9Pcmdhbml6YXRpb24+PC9yZXNvdXJjZT48L2VudHJ5PjxlbnRyeT48ZnVsbFVybCB2YWx1ZT0iaHR0cHM6Ly9wdnMuZ2VtYXRpay5kZS9maGlyL01lZGljYXRpb24vYTlmNmFjOGUtMDZjNS00NzE4LTkyZjItN2Y1ZDdiYThkMmU4Ii8+PHJlc291cmNlPjxNZWRpY2F0aW9uIHhtbG5zPSJodHRwOi8vaGw3Lm9yZy9maGlyIj48aWQgdmFsdWU9ImE5ZjZhYzhlLTA2YzUtNDcxOC05MmYyLTdmNWQ3YmE4ZDJlOCIvPjxtZXRhPjxwcm9maWxlIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX1BSX0VSUF9NZWRpY2F0aW9uX1BaTnwxLjEuMCIvPjwvbWV0YT48ZXh0ZW5zaW9uIHVybD0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9FWF9CYXNlX01lZGljYXRpb25fVHlwZSI+PHZhbHVlQ29kZWFibGVDb25jZXB0Pjxjb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cDovL3Nub21lZC5pbmZvL3NjdCIvPjx2ZXJzaW9uIHZhbHVlPSJodHRwOi8vc25vbWVkLmluZm8vc2N0LzkwMDAwMDAwMDAwMDIwNzAwOC92ZXJzaW9uLzIwMjIwMzMxIi8+PGNvZGUgdmFsdWU9Ijc2MzE1ODAwMyIvPjxkaXNwbGF5IHZhbHVlPSJNZWRpY2luYWwgcHJvZHVjdCAocHJvZHVjdCkiLz48L2NvZGluZz48L3ZhbHVlQ29kZWFibGVDb25jZXB0PjwvZXh0ZW5zaW9uPjxleHRlbnNpb24gdXJsPSJodHRwczovL2ZoaXIua2J2LmRlL1MEggPodHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9FWF9FUlBfTWVkaWNhdGlvbl9DYXRlZ29yeSI+PHZhbHVlQ29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfRVJQX01lZGljYXRpb25fQ2F0ZWdvcnkiLz48Y29kZSB2YWx1ZT0iMDAiLz48L3ZhbHVlQ29kaW5nPjwvZXh0ZW5zaW9uPjxleHRlbnNpb24gdXJsPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX0VYX0VSUF9NZWRpY2F0aW9uX1ZhY2NpbmUiPjx2YWx1ZUJvb2xlYW4gdmFsdWU9InRydWUiLz48L2V4dGVuc2lvbj48ZXh0ZW5zaW9uIHVybD0iaHR0cDovL2ZoaXIuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9ub3JtZ3JvZXNzZSI+PHZhbHVlQ29kZSB2YWx1ZT0iTjMiLz48L2V4dGVuc2lvbj48Y29kZT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHA6Ly9maGlyLmRlL0NvZGVTeXN0ZW0vaWZhL3B6biIvPjxjb2RlIHZhbHVlPSIxMjAwODAzMCIvPjwvY29kaW5nPjx0ZXh0IHZhbHVlPSJCdXNjb3BhbiBQbHVzIEJldXRlbCIvPjwvY29kZT48Zm9ybT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfU0ZISVJfS0JWX0RBUlJFSUNIVU5HU0ZPUk0iLz48Y29kZSB2YWx1ZT0iSUZCIi8+PC9jb2Rpbmc+PC9mb3JtPjxhbW91bnQ+PG51bWVyYXRvcj48ZXh0ZW5zaW9uIHVybD0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9FWF9FUlBfTWVkaWNhdGlvbl9QYWNrYWdpbmdTaXplIj48dmFsdWVTdHJpbmcgdmFsdWU9IjE2Ii8+PC9leHRlbnNpb24+PHVuaXQgdmFsdWU9IlN0ayIvPjwvbnVtZXJhdG9yPjxkZW5vbWluYXRvcj48dmFsdWUgdmFsdWU9IjEiLz48L2Rlbm9taW5hdG9yPjwvYW1vdW50PjwvTWVkaWNhdGlvbj48L3Jlc291cmNlPjwvZW50cnk+PGVudHJ5PjxmdWxsVXJsIHZhbHVlPSJodHRwczovL3B2cy5nZW1hdGlrLmRlL2ZoaQSCA+hyL01lZGljYXRpb25SZXF1ZXN0L2RlMjNiZTNjLWIyMjYtNDhlNy1iZWM1LWMxOGJiZDFiNzM3ZiIvPjxyZXNvdXJjZT48TWVkaWNhdGlvblJlcXVlc3QgeG1sbnM9Imh0dHA6Ly9obDcub3JnL2ZoaXIiPjxpZCB2YWx1ZT0iZGUyM2JlM2MtYjIyNi00OGU3LWJlYzUtYzE4YmJkMWI3MzdmIi8+PG1ldGE+PHByb2ZpbGUgdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9LQlZfUFJfRVJQX1ByZXNjcmlwdGlvbnwxLjEuMCIvPjwvbWV0YT48ZXh0ZW5zaW9uIHVybD0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9FWF9FUlBfQlZHIj48dmFsdWVCb29sZWFuIHZhbHVlPSJmYWxzZSIvPjwvZXh0ZW5zaW9uPjxleHRlbnNpb24gdXJsPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX0VYX0VSUF9FbWVyZ2VuY3lTZXJ2aWNlc0ZlZSI+PHZhbHVlQm9vbGVhbiB2YWx1ZT0iZmFsc2UiLz48L2V4dGVuc2lvbj48ZXh0ZW5zaW9uIHVybD0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9FWF9FUlBfTXVsdGlwbGVfUHJlc2NyaXB0aW9uIj48ZXh0ZW5zaW9uIHVybD0iS2VubnplaWNoZW4iPjx2YWx1ZUJvb2xlYW4gdmFsdWU9ImZhbHNlIi8+PC9leHRlbnNpb24+PC9leHRlbnNpb24+PGV4dGVuc2lvbiB1cmw9Imh0dHBzOi8vZmhpci5rYnYuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9LQlZfRVhfRk9SX1N0YXR1c0NvUGF5bWVudCI+PHZhbHVlQ29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfRk9SX1N0YXR1c0NvUGF5bWVudCIvPjxjb2RlIHZhbHVlPSIxIi8+PC92YWx1ZUNvZGluZz48L2V4dGVuc2lvbj48c3RhdHVzIHZhbHVlPSJhY3RpdmUiLz48aW50ZW50IHZhbHVlPSJvcmRlciIvPjxtZWRpY2F0aW9uUmVmZXJlbmNlPjxyZWZlcmVuY2UgdmFsdWU9Ik1lZGljYXRpb24vYTlmNmFjBIIDFjhlLTA2YzUtNDcxOC05MmYyLTdmNWQ3YmE4ZDJlOCIvPjwvbWVkaWNhdGlvblJlZmVyZW5jZT48c3ViamVjdD48cmVmZXJlbmNlIHZhbHVlPSJQYXRpZW50LzJiN2I1OGYzLWJhMjItNGI3Mi04MzVlLWExM2I3ODQ0ODgzYSIvPjwvc3ViamVjdD48YXV0aG9yZWRPbiB2YWx1ZT0iMjAyNS0wNi0yNSIvPjxyZXF1ZXN0ZXI+PHJlZmVyZW5jZSB2YWx1ZT0iUHJhY3RpdGlvbmVyLzIyODg4ZjU3LWI2OGMtNDU0NC05YjRiLTJhNmUxYzk0NDk0MiIvPjwvcmVxdWVzdGVyPjxpbnN1cmFuY2U+PHJlZmVyZW5jZSB2YWx1ZT0iQ292ZXJhZ2UvY2EzMjI0N2EtNDhjMy00ZGY3LTk4MmYtNjMzMzcwZTU4ZGQwIi8+PC9pbnN1cmFuY2U+PGRvc2FnZUluc3RydWN0aW9uPjxleHRlbnNpb24gdXJsPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX0VYX0VSUF9Eb3NhZ2VGbGFnIj48dmFsdWVCb29sZWFuIHZhbHVlPSJ0cnVlIi8+PC9leHRlbnNpb24+PHRleHQgdmFsdWU9IjEtMS0xLTMtMS0yLTIiLz48L2Rvc2FnZUluc3RydWN0aW9uPjxkaXNwZW5zZVJlcXVlc3Q+PHF1YW50aXR5Pjx2YWx1ZSB2YWx1ZT0iOCIvPjxzeXN0ZW0gdmFsdWU9Imh0dHA6Ly91bml0c29mbWVhc3VyZS5vcmciLz48Y29kZSB2YWx1ZT0ie1BhY2thZ2V9Ii8+PC9xdWFudGl0eT48L2Rpc3BlbnNlUmVxdWVzdD48c3Vic3RpdHV0aW9uPjxhbGxvd2Vk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";
  private static final String EXPECTED_HASH_FROM_MESSAGE_DIGEST =
      "FjMneDnmWgBoJeD2OrTwffzwvX0O6ojsGefSc685/X8=";

  @Test
  void shouldCompareSignature() {
    val erxReceipt =
        parser.decode(
            ErxReceipt.class,
            ResourceLoader.readFileFromResource(
                "fhir/valid/erp/1.4.0/receiptbundle/fdResponse.xml"));
    val step =
        ReceiptBundleVerifier.compareSignatureHashWith(
            Base64.getDecoder().decode(SIGNED_DOC_AS_BASE64), ErpAfos.A_19233);
    step.apply(erxReceipt);
  }

  @Test
  void shouldFailAtCompareSignature() {
    val erxReceipt =
        parser.decode(
            ErxReceipt.class,
            ResourceLoader.readFileFromResource(
                "fhir/valid/erp/1.4.0/receiptbundle/dffbfd6a-5712-4798-bdc8-07201eb77ab8.json"));
    val step =
        ReceiptBundleVerifier.compareSignatureHashWith(
            Base64.getDecoder().decode(SIGNED_DOC_AS_BASE64), ErpAfos.A_19233);
    assertThrows(AssertionError.class, () -> step.apply(erxReceipt));
  }

  @Test
  void shouldGetHashFromSignedDoc() {
    val hash = ReceiptBundleVerifier.getHashAsBase64String(SIGNED_DOC_AS_BASE64);
    assertEquals(EXPECTED_HASH_FROM_MESSAGE_DIGEST, hash);
  }

  @Test
  void shouldFailToGetHashFromSignedDoc() {
    val hash = ReceiptBundleVerifier.getHashAsBase64String(SIGNED_DOC_AS_BASE64);
    assertNotEquals(EXPECTED_HASH_FROM_MESSAGE_DIGEST + "=", hash);
  }

  @Test
  void hashShouldNotBeEmpty() {
    val hash = ReceiptBundleVerifier.getHashAsBase64String(SIGNED_DOC_AS_BASE64);
    assertFalse(hash.isEmpty());
  }

  @Test
  void shouldThrowException() {
    assertThrows(
        IllegalArgumentException.class,
        () -> {
          ReceiptBundleVerifier.getHashAsBase64String(SIGNED_DOC_AS_BASE64 + "=123");
        });
  }
}
