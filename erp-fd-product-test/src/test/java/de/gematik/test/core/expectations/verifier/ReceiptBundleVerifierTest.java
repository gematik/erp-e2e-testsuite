/*
 * Copyright 2024 gematik GmbH
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package de.gematik.test.core.expectations.verifier;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.jupiter.api.Assertions.*;

import de.gematik.bbriccs.utils.PrivateConstructorsUtil;
import de.gematik.bbriccs.utils.ResourceLoader;
import de.gematik.test.core.expectations.requirements.CoverageReporter;
import de.gematik.test.core.expectations.requirements.ErpAfos;
import de.gematik.test.erezept.fhir.resources.erp.ErxReceipt;
import de.gematik.test.erezept.fhir.testutil.ParsingTest;
import java.util.Base64;
import lombok.val;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

class ReceiptBundleVerifierTest extends ParsingTest {

  private static final String NEW_RECEIPT_VERSION =
      "fhir/valid/erp/1.2.0/receiptbundle/NeueVersion_0e0f861-0000-0000-0003-000000000000.xml";
  private static final String INVALID_RECEIPT_BUNDLE =
      "fhir/invalid/erp/1.2.0/receiptbundle/org_fd_response_manipulatedreferencesfullurl.xml";

  @BeforeEach
  void init() {
    CoverageReporter.getInstance().startTestcase("not needed");
  }

  @Test
  void shouldNotInstantiateUtilityClass() {
    assertTrue(PrivateConstructorsUtil.isUtilityConstructor(ReceiptBundleVerifier.class));
  }

  @Test
  void shouldPassOnValidReceipt() {
    val bundle =
        parser.decode(ErxReceipt.class, ResourceLoader.readFileFromResource(NEW_RECEIPT_VERSION));
    val step = ReceiptBundleVerifier.entryFullUrlIsUuid();
    step.apply(bundle);
  }

  @Test
  void shouldFailOnInvalidReceiptEntryFullUrl() {
    val invalidReceipt =
        parser.decode(
            ErxReceipt.class, ResourceLoader.readFileFromResource(INVALID_RECEIPT_BUNDLE));

    val step = ReceiptBundleVerifier.entryFullUrlIsUuid();
    assertThrows(AssertionError.class, () -> step.apply(invalidReceipt));
  }

  @Test
  void shouldFailOnInvalidReceiptEntryCompAuthorReference() {
    val bundle =
        parser.decode(
            ErxReceipt.class, ResourceLoader.readFileFromResource(INVALID_RECEIPT_BUNDLE));
    bundle.getAuthor().setReference("123Test");
    val step = ReceiptBundleVerifier.compAuthorRefIsUuid();
    assertThrows(AssertionError.class, () -> step.apply(bundle));
  }

  @Test
  void shouldFailOnInvalidReceiptEntrySignatureRef() {
    val bundle =
        parser.decode(
            ErxReceipt.class, ResourceLoader.readFileFromResource(INVALID_RECEIPT_BUNDLE));
    bundle.getSignature().getWho().setReference("123Test");
    val step = ReceiptBundleVerifier.signatureRefIsUuid();
    assertThrows(AssertionError.class, () -> step.apply(bundle));
  }

  @Test
  void shouldFailOnInvalidReceiptEntryCompSectionRef() {
    val bundle =
        parser.decode(
            ErxReceipt.class, ResourceLoader.readFileFromResource(INVALID_RECEIPT_BUNDLE));

    bundle.getQesDigestRefInComposSect().getEntryFirstRep().setReference("123Test");
    val step = ReceiptBundleVerifier.compSectionRefIsUuid();

    assertThrows(AssertionError.class, () -> step.apply(bundle));
  }

  @Test
  void referenceValidationShouldPassOnValidReceipt() {
    val bundle =
        parser.decode(ErxReceipt.class, ResourceLoader.readFileFromResource(NEW_RECEIPT_VERSION));

    val step = ReceiptBundleVerifier.compAuthorRefIsUuid();
    step.apply(bundle);
    val step2 = ReceiptBundleVerifier.compSectionRefIsUuid();
    step2.apply(bundle);
    val step3 = ReceiptBundleVerifier.signatureRefIsUuid();
    step3.apply(bundle);
  }

  @Test
  void shouldGetBinary() {
    val bundle =
        parser.decode(
            ErxReceipt.class,
            ResourceLoader.readFileFromResource(
                "fhir/invalid/erp/1.2.0/receiptbundle/org_fd_response_manipulatedreferencesfullurl.xml"));
    val binary = bundle.getQesDigestBinary();
    val code = binary.getContentElement().getValueAsString();
    assertEquals("Z+1XGxG6ClhoOqTLk8aU3yWiSSWfMUMubtLA3EAxV4E=", code);
  }

  private static final String SIGNED_DOC_AS_BASE64 =
      "MIIxJwYJKoZIhvcNAQcCoIIxGDCCMRQCAQExDTALBglghkgBZQMEAgEwgiqABgkqhkiG9w0BBwGggipxBIIqbTxCdW5kbGUgeG1sbnM9Imh0dHA6Ly9obDcub3JnL2ZoaXIiPjxpZCB2YWx1ZT0iNmUxMGFmZDUtMjhlMi00ZTI5LWIzZWYtY2IwNjY3MzE1NTg5Ii8+PG1ldGE+PGxhc3RVcGRhdGVkIHZhbHVlPSIyMDI0LTAyLTI3VDE1OjQxOjE0LjY5NyswMTowMCIvPjxwcm9maWxlIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX1BSX0VSUF9CdW5kbGV8MS4xLjAiLz48L21ldGE+PGlkZW50aWZpZXI+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9nZW1hdGlrLmRlL2ZoaXIvZXJwL05hbWluZ1N5c3RlbS9HRU1fRVJQX05TX1ByZXNjcmlwdGlvbklkIi8+PHZhbHVlIHZhbHVlPSIxNjAuMDAwLjA3MC44NjYuMjI2LjYyIi8+PC9pZGVudGlmaWVyPjx0eXBlIHZhbHVlPSJkb2N1bWVudCIvPjx0aW1lc3RhbXAgdmFsdWU9IjIwMjQtMDItMjdUMTU6NDE6MTQuNjk3KzAxOjAwIi8+PGVudHJ5PjxmdWxsVXJsIHZhbHVlPSJodHRwczovL3B2cy5nZW1hdGlrLmRlL2ZoaXIvQ29tcG9zaXRpb24vNWYyY2MwMDgtYmFkYy00OTYxLWI4MWEtYTY4MTU1NzZjYmI3Ii8+PHJlc291cmNlPjxDb21wb3NpdGlvbiB4bWxucz0iaHR0cDovL2hsNy5vcmcvZmhpciI+PGlkIHZhbHVlPSI1ZjJjYzAwOC1iYWRjLTQ5NjEtYjgxYS1hNjgxNTU3NmNiYjciLz48bWV0YT48cHJvZmlsZSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9QUl9FUlBfQ29tcG9zaXRpb258MS4xLjAiLz48L21ldGE+PGV4dGVuc2lvbiB1cmw9Imh0dHBzOi8vZmhpci5rYnYuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9LQlZfRVhfRk9SX0xlZ2FsX2Jhc2lzIj48dmFsdWVDb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9Db2RlU3lzdGVtL0tCVl9DU19TRkhJUl9LQlZfU1RBVFVTS0VOTlpFSUNIRU4iLz48Y29kZSB2YWx1ZT0iMDAiLz48L3ZhbHVlQ29kaW5nPjwvZXh0ZW5zaW9uPjxzdGF0dXMgdmFsdWU9ImZpbmFsIi8+PHR5cGU+PGNvZGluZz48c3lzdGVtIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL0NvZGVTeXN0ZW0vS0JWX0NTX1NGSElSX0tCVl9GT1JNVUxBUl9BUlQiLz48Y29kZSB2YWx1ZT0iZTE2QSIvPjwvY29kaW5nPjwvdHlwZT48c3ViamVjdD48cmVmZXJlbmNlIHZhbHVlPSJQYXRpZW50L2RmZDdjNjhlLWVmN2MtNDllNi1hZGNhLTY3NzU4N2JkYmZjZSIvPjwvc3ViamVjdD48ZGF0ZSB2YWx1ZT0iMjAyNC0wMi0yN1QxNTo0MToxNCswMTowMCIvPjxhdXRob3I+PHJlZmVyZW5jZSB2YWx1ZT0iUHJhY3RpdGlvbmVyL2Y3ODQ5YTg3LTA4ZWQtNDY2NC1iMjdhLTY2ODIyY2ViNTBmZSIvPjx0eXBlIHZhbHVlPSJQcmFjdGl0aW9uZXIiLz48L2F1dGhvcj48YXV0aG9yPjx0eXBlIHZhbHVlPSJEZXZpY2UiLz48aWRlbnRpZmllcj48c3lzdGVtIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL05hbWluZ1N5c3RlbS9LQlZfTlNfRk9SX1BydWVmbnVtbWVyIi8+PHZhbHVlIHZhbHVlPSJHRU1BVElLLzQxMC8yMTA5LzM2LzEyMyIvPjwvaWRlbnRpZmllcj48L2F1dGhvcj48dGl0bGUgdmFsdWU9ImVsZWt0cm9uaXNjaGUgQXJ6bmVpbWl0dGVsdmVyb3JkbnVuZyIvPjxjdXN0b2RpYW4+PHJlZmVyZW5jZSB2YWx1ZT0iT3JnYW5pemF0aW9uL2E2YjQ1YjUyLTRmNzMtNDFjMC1iYTY3LWMwOTQwOTYxNDgyMCIvPjwvY3VzdG9kaWFuPjxzZWN0aW9uPjxjb2RlPjxjb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9Db2RlU3lzdGVtL0tCVl9DU19FUlBfU2VjdGlvbl9UeXBlIi8+PGNvZGUgdmFsdWU9IkNvdmVyYWdlIi8+PC9jb2Rpbmc+PC9jb2RlPjxlbnRyeT48cmVmZXJlbmNlIHZhbHVlPSJDb3ZlcmFnZS8xNDdjMWYzMi05MTg3LTQ3OGYtYjk1ZS0wYTRhZGJjMzA4M2MiLz48L2VudHJ5Pjwvc2VjdGlvbj48c2VjdGlvbj48Y29kZT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfRVJQX1NlY3Rpb25fVHlwZSIvPjxjb2RlIHZhbHVlPSJQcmVzY3JpcHRpb24iLz48L2NvZGluZz48L2NvZGU+PGVudHJ5PjxyZWZlcmVuY2UgdmFsdWU9Ik1lZGljYXRpb25SZXF1ZXN0L2EyYjI4ODBlLTg4MzItNDJmYy1hMGZiLWE0OThkMTk3MWMzNyIvPjwvZW50cnk+PC9zZWN0aW9uPjwvQ29tcG9zaXRpb24+PC9yZXNvdXJjZT48L2VudHJ5PjxlbnRyeT48ZnVsbFVybCB2YWx1ZT0iaHR0cHM6Ly9wdnMuZ2VtYXRpay5kZS9maGlyL01lZGljYXRpb24vMjBlODJkMzgtNzNkZC00ZjU3LWJmNGUtZGY2NjYxNDY2NDNlIi8+PHJlc291cmNlPjxNZWRpY2F0aW9uIHhtbG5zPSJodHRwOi8vaGw3Lm9yZy9maGlyIj48aWQgdmFsdWU9IjIwZTgyZDM4LTczZGQtNGY1Ny1iZjRlLWRmNjY2MTQ2NjQzZSIvPjxtZXRhPjxwcm9maWxlIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX1BSX0VSUF9NZWRpY2F0aW9uX1BaTnwxLjEuMCIvPjwvbWV0YT48ZXh0ZW5zaW9uIHVybD0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9FWF9CYXNlX01lZGljYXRpb25fVHlwZSI+PHZhbHVlQ29kZWFibGVDb25jZXB0Pjxjb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cDovL3Nub21lZC5pbmZvL3NjdCIvPjx2ZXJzaW9uIHZhbHVlPSJodHRwOi8vc25vbWVkLmluZm8vc2N0LzkwMDAwMDAwMDAwMDIwNzAwOC92ZXJzaW9uLzIwMjIwMzMxIi8+PGNvZGUgdmFsdWU9Ijc2MzE1ODAwMyIvPjxkaXNwbGF5IHZhbHVlPSJNZWRpY2luYWwgcHJvZHVjdCAocHJvZHVjdCkiLz48L2NvZGluZz48L3ZhbHVlQ29kZWFibGVDb25jZXB0PjwvZXh0ZW5zaW9uPjxleHRlbnNpb24gdXJsPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX0VYX0VSUF9NZWRpY2F0aW9uX0NhdGVnb3J5Ij48dmFsdWVDb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9Db2RlU3lzdGVtL0tCVl9DU19FUlBfTWVkaWNhdGlvbl9DYXRlZ29yeSIvPjxjb2RlIHZhbHVlPSIwMCIvPjwvdmFsdWVDb2Rpbmc+PC9leHRlbnNpb24+PGV4dGVuc2lvbiB1cmw9Imh0dHBzOi8vZmhpci5rYnYuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9LQlZfRVhfRVJQX01lZGljYXRpb25fVmFjY2luZSI+PHZhbHVlQm9vbGVhbiB2YWx1ZT0iZmFsc2UiLz48L2V4dGVuc2lvbj48ZXh0ZW5zaW9uIHVybD0iaHR0cDovL2ZoaXIuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9ub3JtZ3JvZXNzZSI+PHZhbHVlQ29kZSB2YWx1ZT0iTjEiLz48L2V4dGVuc2lvbj48Y29kZT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHA6Ly9maGlyLmRlL0NvZGVTeXN0ZW0vaWZhL3B6biIvPjxjb2RlIHZhbHVlPSIzMTc3MTkwMyIvPjwvY29kaW5nPjx0ZXh0IHZhbHVlPSJJYnUtTHlzaW5IRVhBTMKuIDIwMDAgbWciLz48L2NvZGU+PGZvcm0+PGNvZGluZz48c3lzdGVtIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL0NvZGVTeXN0ZW0vS0JWX0NTX1NGSElSX0tCVl9EQVJSRUlDSFVOR1NGT1JNIi8+PGNvZGUgdmFsdWU9IkhLTSIvPjwvY29kaW5nPjwvZm9ybT48YW1vdW50PjxudW1lcmF0b3I+PGV4dGVuc2lvbiB1cmw9Imh0dHBzOi8vZmhpci5rYnYuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9LQlZfRVhfRVJQX01lZGljYXRpb25fUGFja2FnaW5nU2l6ZSI+PHZhbHVlU3RyaW5nIHZhbHVlPSIxNCIvPjwvZXh0ZW5zaW9uPjx1bml0IHZhbHVlPSJTdGsiLz48L251bWVyYXRvcj48ZGVub21pbmF0b3I+PHZhbHVlIHZhbHVlPSIxIi8+PC9kZW5vbWluYXRvcj48L2Ftb3VudD48L01lZGljYXRpb24+PC9yZXNvdXJjZT48L2VudHJ5PjxlbnRyeT48ZnVsbFVybCB2YWx1ZT0iaHR0cHM6Ly9wdnMuZ2VtYXRpay5kZS9maGlyL1BhdGllbnQvZGZkN2M2OGUtZWY3Yy00OWU2LWFkY2EtNjc3NTg3YmRiZmNlIi8+PHJlc291cmNlPjxQYXRpZW50IHhtbG5zPSJodHRwOi8vaGw3Lm9yZy9maGlyIj48aWQgdmFsdWU9ImRmZDdjNjhlLWVmN2MtNDllNi1hZGNhLTY3NzU4N2JkYmZjZSIvPjxtZXRhPjxwcm9maWxlIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX1BSX0ZPUl9QYXRpZW50fDEuMS4wIi8+PC9tZXRhPjxpZGVudGlmaWVyPjx0eXBlPjxjb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cDovL2ZoaXIuZGUvQ29kZVN5c3RlbS9pZGVudGlmaWVyLXR5cGUtZGUtYmFzaXMiLz48Y29kZSB2YWx1ZT0iR0tWIi8+PC9jb2Rpbmc+PC90eXBlPjxzeXN0ZW0gdmFsdWU9Imh0dHA6Ly9maGlyLmRlL3NpZC9na3Yva3ZpZC0xMCIvPjx2YWx1ZSB2YWx1ZT0iWDExMDQ5ODU2NSIvPjwvaWRlbnRpZmllcj48bmFtZT48dXNlIHZhbHVlPSJvZmZpY2lhbCIvPjxmYW1pbHkgdmFsdWU9IkjDvGxsbWFubiI+PGV4dGVuc2lvbiB1cmw9Imh0dHA6Ly9obDcub3JnL2ZoaXIvU3RydWN0dXJlRGVmaW5pdGlvbi9odW1hbm5hbWUtb3duLW5hbWUiPjx2YWx1ZVN0cmluZyB2YWx1ZT0iSMO8bGxtYW5uIi8+PC9leHRlbnNpb24+PC9mYW1pbHk+PGdpdmVuIHZhbHVlPSJTaW5hIi8+PC9uYW1lPjxiaXJ0aERhdGUgdmFsdWU9IjE5NjMtMTItMjQiLz48YWRkcmVzcz48dHlwZSB2YWx1ZT0iYm90aCIvPjxsaW5lIHZhbHVlPSJLYWlzZXJwbGF0eiA0NWIiPjxleHRlbnNpb24gdXJsPSJodHRwOi8vaGw3Lm9yZy9maGlyL1N0cnVjdHVyZURlZmluaXRpb24vaXNvMjEwOTAtQURYUC1ob3VzZU51bWJlciI+PHZhbHVlU3RyaW5nIHZhbHVlPSI0NWIiLz48L2V4dGVuc2lvbj48ZXh0ZW5zaW9uIHVybD0iaHR0cDovL2hsNy5vcmcvZmhpci9TdHJ1Y3R1cmVEZWZpbml0aW9uL2lzbzIxMDkwLUFEWFAtc3RyZWV0TmFtZSI+PHZhbHVlU3RyaW5nIHZhbHVlPSJLYWlzZXJwbGF0eiIvPjwvZXh0ZW5zaW9uPjwvbGluZT48Y2l0eSB2YWx1ZT0iU2Now7ZuIExhcnMiLz48cG9zdGFsQ29kZSB2YWx1ZT0iNDM1NTQiLz48Y291bnRyeSB2YWx1ZT0iRCIvPjwvYWRkcmVzcz48L1BhdGllbnQ+PC9yZXNvdXJjZT48L2VudHJ5PjxlbnRyeT48ZnVsbFVybCB2YWx1ZT0iaHR0cHM6Ly9wdnMuZ2VtYXRpay5kZS9maGlyL09yZ2FuaXphdGlvbi9hNmI0NWI1Mi00ZjczLTQxYzAtYmE2Ny1jMDk0MDk2MTQ4MjAiLz48cmVzb3VyY2U+PE9yZ2FuaXphdGlvbiB4bWxucz0iaHR0cDovL2hsNy5vcmcvZmhpciI+PGlkIHZhbHVlPSJhNmI0NWI1Mi00ZjczLTQxYzAtYmE2Ny1jMDk0MDk2MTQ4MjAiLz48bWV0YT48cHJvZmlsZSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9QUl9GT1JfT3JnYW5pemF0aW9ufDEuMS4wIi8+PC9tZXRhPjxpZGVudGlmaWVyPjx0eXBlPjxjb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cDovL3Rlcm1pbm9sb2d5LmhsNy5vcmcvQ29kZVN5c3RlbS92Mi0wMjAzIi8+PGNvZGUgdmFsdWU9IkJTTlIiLz48L2NvZGluZz48L3R5cGU+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9OYW1pbmdTeXN0ZW0vS0JWX05TX0Jhc2VfQlNOUiIvPjx2YWx1ZSB2YWx1ZT0iNzg3NDI0NDg0Ii8+PC9pZGVudGlmaWVyPjxuYW1lIHZhbHVlPSJBcnp0cHJheGlzIFVsbWVud2FsZCIvPjx0ZWxlY29tPjxzeXN0ZW0gdmFsdWU9InBob25lIi8+PHZhbHVlIHZhbHVlPSIrNDktNzY0Ny0wMjM1MzA1MiIvPjwvdGVsZWNvbT48dGVsZWNvbT48c3lzdGVtIHZhbHVlPSJlbWFpbCIvPjx2YWx1ZSB2YWx1ZT0ic2VsaW0uZXJtQHRzY2hpZXJzLmluZm8iLz48L3RlbGVjb20+PGFkZHJlc3M+PHR5cGUgdmFsdWU9ImJvdGgiLz48bGluZSB2YWx1ZT0iS3VydC1TY2h1bWFjaGVyLVJpbmcgMDRiIj48ZXh0ZW5zaW9uIHVybD0iaHR0cDovL2hsNy5vcmcvZmhpci9TdHJ1Y3R1cmVEZWZpbml0aW9uL2lzbzIxMDkwLUFEWFAtaG91c2VOdW1iZXIiPjx2YWx1ZVN0cmluZyB2YWx1ZT0iMDRiIi8+PC9leHRlbnNpb24+PGV4dGVuc2lvbiB1cmw9Imh0dHA6Ly9obDcub3JnL2ZoaXIvU3RydWN0dXJlRGVmaW5pdGlvbi9pc28yMTA5MC1BRFhQLXN0cmVldE5hbWUiPjx2YWx1ZVN0cmluZyB2YWx1ZT0iS3VydC1TY2h1bWFjaGVyLVJpbmciLz48L2V4dGVuc2lvbj48L2xpbmU+PGNpdHkgdmFsdWU9IlZpb2xhc2NoZWlkIi8+PHBvc3RhbENvZGUgdmFsdWU9Ijg0MjgzIi8+PGNvdW50cnkgdmFsdWU9IkQiLz48L2FkZHJlc3M+PC9Pcmdhbml6YXRpb24+PC9yZXNvdXJjZT48L2VudHJ5PjxlbnRyeT48ZnVsbFVybCB2YWx1ZT0iaHR0cHM6Ly9wdnMuZ2VtYXRpay5kZS9maGlyL0NvdmVyYWdlLzE0N2MxZjMyLTkxODctNDc4Zi1iOTVlLTBhNGFkYmMzMDgzYyIvPjxyZXNvdXJjZT48Q292ZXJhZ2UgeG1sbnM9Imh0dHA6Ly9obDcub3JnL2ZoaXIiPjxpZCB2YWx1ZT0iMTQ3YzFmMzItOTE4Ny00NzhmLWI5NWUtMGE0YWRiYzMwODNjIi8+PG1ldGE+PHByb2ZpbGUgdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9LQlZfUFJfRk9SX0NvdmVyYWdlfDEuMS4wIi8+PC9tZXRhPjxleHRlbnNpb24gdXJsPSJodHRwOi8vZmhpci5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL2drdi9iZXNvbmRlcmUtcGVyc29uZW5ncnVwcGUiPjx2YWx1ZUNvZGluZz48c3lzdGVtIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL0NvZGVTeXN0ZW0vS0JWX0NTX1NGSElSX0tCVl9QRVJTT05FTkdSVVBQRSIvPjxjb2RlIHZhbHVlPSIwMCIvPjwvdmFsdWVDb2Rpbmc+PC9leHRlbnNpb24+PGV4dGVuc2lvbiB1cmw9Imh0dHA6Ly9maGlyLmRlL1N0cnVjdHVyZURlZmluaXRpb24vZ2t2L2RtcC1rZW5uemVpY2hlbiI+PHZhbHVlQ29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfU0ZISVJfS0JWX0RNUCIvPjxjb2RlIHZhbHVlPSIwMCIvPjwvdmFsdWVDb2Rpbmc+PC9leHRlbnNpb24+PGV4dGVuc2lvbiB1cmw9Imh0dHA6Ly9maGlyLmRlL1N0cnVjdHVyZURlZmluaXRpb24vZ2t2L3dvcCI+PHZhbHVlQ29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfU0ZISVJfSVRBX1dPUCIvPjxjb2RlIHZhbHVlPSI5MyIvPjwvdmFsdWVDb2Rpbmc+PC9leHRlbnNpb24+PGV4dGVuc2lvbiB1cmw9Imh0dHA6Ly9maGlyLmRlL1N0cnVjdHVyZURlZmluaXRpb24vZ2t2L3ZlcnNpY2hlcnRlbmFydCI+PHZhbHVlQ29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfU0ZISVJfS0JWX1ZFUlNJQ0hFUlRFTlNUQVRVUyIvPjxjb2RlIHZhbHVlPSIxIi8+PC92YWx1ZUNvZGluZz48L2V4dGVuc2lvbj48c3RhdHVzIHZhbHVlPSJhY3RpdmUiLz48dHlwZT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHA6Ly9maGlyLmRlL0NvZGVTeXN0ZW0vdmVyc2ljaGVydW5nc2FydC1kZS1iYXNpcyIvPjxjb2RlIHZhbHVlPSJHS1YiLz48L2NvZGluZz48L3R5cGU+PGJlbmVmaWNpYXJ5PjxyZWZlcmVuY2UgdmFsdWU9IlBhdGllbnQvNTMxMmExMzYtMjUzNC00OGI5LWIyNmUtMDUyNTYwZGFlMTRmIi8+PC9iZW5lZmljaWFyeT48cGF5b3I+PGlkZW50aWZpZXI+PHN5c3RlbSB2YWx1ZT0iaHR0cDovL2ZoaXIuZGUvc2lkL2FyZ2UtaWsvaWtuciIvPjx2YWx1ZSB2YWx1ZT0iMTAzMTIxMDEzIi8+PC9pZGVudGlmaWVyPjxkaXNwbGF5IHZhbHVlPSJhdGxhcyBCS0sgYWhsbWFubiIvPjwvcGF5b3I+PC9Db3ZlcmFnZT48L3Jlc291cmNlPjwvZW50cnk+PGVudHJ5PjxmdWxsVXJsIHZhbHVlPSJodHRwczovL3B2cy5nZW1hdGlrLmRlL2ZoaXIvUHJhY3RpdGlvbmVyL2Y3ODQ5YTg3LTA4ZWQtNDY2NC1iMjdhLTY2ODIyY2ViNTBmZSIvPjxyZXNvdXJjZT48UHJhY3RpdGlvbmVyIHhtbG5zPSJodHRwOi8vaGw3Lm9yZy9maGlyIj48aWQgdmFsdWU9ImY3ODQ5YTg3LTA4ZWQtNDY2NC1iMjdhLTY2ODIyY2ViNTBmZSIvPjxtZXRhPjxwcm9maWxlIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX1BSX0ZPUl9QcmFjdGl0aW9uZXJ8MS4xLjAiLz48L21ldGE+PGlkZW50aWZpZXI+PHR5cGU+PGNvZGluZz48c3lzdGVtIHZhbHVlPSJodHRwOi8vdGVybWlub2xvZ3kuaGw3Lm9yZy9Db2RlU3lzdGVtL3YyLTAyMDMiLz48Y29kZSB2YWx1ZT0iTEFOUiIvPjwvY29kaW5nPjwvdHlwZT48c3lzdGVtIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL05hbWluZ1N5c3RlbS9LQlZfTlNfQmFzZV9BTlIiLz48dmFsdWUgdmFsdWU9IjM4Mzk4MzQ5OCIvPjwvaWRlbnRpZmllcj48bmFtZT48dXNlIHZhbHVlPSJvZmZpY2lhbCIvPjxmYW1pbHkgdmFsdWU9IlVsbWVud2FsZCI+PGV4dGVuc2lvbiB1cmw9Imh0dHA6Ly9obDcub3JnL2ZoaXIvU3RydWN0dXJlRGVmaW5pdGlvbi9odW1hbm5hbWUtb3duLW5hbWUiPjx2YWx1ZVN0cmluZyB2YWx1ZT0iVWxtZW53YWxkIi8+PC9leHRlbnNpb24+PC9mYW1pbHk+PGdpdmVuIHZhbHVlPSJBZGVsaGVpZCIvPjxwcmVmaXggdmFsdWU9IkRyLiI+PGV4dGVuc2lvbiB1cmw9Imh0dHA6Ly9obDcub3JnL2ZoaXIvU3RydWN0dXJlRGVmaW5pdGlvbi9pc28yMTA5MC1FTi1xdWFsaWZpZXIiPjx2YWx1ZUNvZGUgdmFsdWU9IkFDIi8+PC9leHRlbnNpb24+PC9wcmVmaXg+PC9uYW1lPjxxdWFsaWZpY2F0aW9uPjxjb2RlPjxjb2Rpbmc+PHN5c3RlbSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9Db2RlU3lzdGVtL0tCVl9DU19GT1JfUXVhbGlmaWNhdGlvbl9UeXBlIi8+PGNvZGUgdmFsdWU9IjAwIi8+PC9jb2Rpbmc+PC9jb2RlPjwvcXVhbGlmaWNhdGlvbj48cXVhbGlmaWNhdGlvbj48Y29kZT48Y29kaW5nPjxzeXN0ZW0gdmFsdWU9Imh0dHBzOi8vZmhpci5rYnYuZGUvQ29kZVN5c3RlbS9LQlZfQ1NfRk9SX0JlcnVmc2JlemVpY2hudW5nIi8+PGNvZGUgdmFsdWU9IkJlcnVmc2JlemVpY2hudW5nIi8+PC9jb2Rpbmc+PHRleHQgdmFsdWU9IlN1cGVyLUZhY2hhcnp0IGbDvHIgYWxsZXMgTcO2Z2xpY2hlIi8+PC9jb2RlPjwvcXVhbGlmaWNhdGlvbj48L1ByYWN0aXRpb25lcj48L3Jlc291cmNlPjwvZW50cnk+PGVudHJ5PjxmdWxsVXJsIHZhbHVlPSJodHRwczovL3B2cy5nZW1hdGlrLmRlL2ZoaXIvTWVkaWNhdGlvblJlcXVlc3QvYTJiMjg4MGUtODgzMi00MmZjLWEwZmItYTQ5OGQxOTcxYzM3Ii8+PHJlc291cmNlPjxNZWRpY2F0aW9uUmVxdWVzdCB4bWxucz0iaHR0cDovL2hsNy5vcmcvZmhpciI+PGlkIHZhbHVlPSJhMmIyODgwZS04ODMyLTQyZmMtYTBmYi1hNDk4ZDE5NzFjMzciLz48bWV0YT48cHJvZmlsZSB2YWx1ZT0iaHR0cHM6Ly9maGlyLmtidi5kZS9TdHJ1Y3R1cmVEZWZpbml0aW9uL0tCVl9QUl9FUlBfUHJlc2NyaXB0aW9ufDEuMS4wIi8+PC9tZXRhPjxleHRlbnNpb24gdXJsPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX0VYX0VSUF9CVkciPjx2YWx1ZUJvb2xlYW4gdmFsdWU9ImZhbHNlIi8+PC9leHRlbnNpb24+PGV4dGVuc2lvbiB1cmw9Imh0dHBzOi8vZmhpci5rYnYuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9LQlZfRVhfRVJQX0VtZXJnZW5jeVNlcnZpY2VzRmVlIj48dmFsdWVCb29sZWFuIHZhbHVlPSJ0cnVlIi8+PC9leHRlbnNpb24+PGV4dGVuc2lvbiB1cmw9Imh0dHBzOi8vZmhpci5rYnYuZGUvU3RydWN0dXJlRGVmaW5pdGlvbi9LQlZfRVhfRVJQX011bHRpcGxlX1ByZXNjcmlwdGlvbiI+PGV4dGVuc2lvbiB1cmw9Iktlbm56ZWljaGVuIj48dmFsdWVCb29sZWFuIHZhbHVlPSJmYWxzZSIvPjwvZXh0ZW5zaW9uPjwvZXh0ZW5zaW9uPjxleHRlbnNpb24gdXJsPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX0VYX0ZPUl9TdGF0dXNDb1BheW1lbnQiPjx2YWx1ZUNvZGluZz48c3lzdGVtIHZhbHVlPSJodHRwczovL2ZoaXIua2J2LmRlL0NvZGVTeXN0ZW0vS0JWX0NTX0ZPUl9TdGF0dXNDb1BheW1lbnQiLz48Y29kZSB2YWx1ZT0iMCIvPjwvdmFsdWVDb2Rpbmc+PC9leHRlbnNpb24+PHN0YXR1cyB2YWx1ZT0iYWN0aXZlIi8+PGludGVudCB2YWx1ZT0ib3JkZXIiLz48bWVkaWNhdGlvblJlZmVyZW5jZT48cmVmZXJlbmNlIHZhbHVlPSJNZWRpY2F0aW9uLzIwZTgyZDM4LTczZGQtNGY1Ny1iZjRlLWRmNjY2MTQ2NjQzZSIvPjwvbWVkaWNhdGlvblJlZmVyZW5jZT48c3ViamVjdD48cmVmZXJlbmNlIHZhbHVlPSJQYXRpZW50L2Q4NzQ3Njg0LTgyYmEtNDgzOC04NjE1LWE5MTg5ODUzYTA2ZiIvPjwvc3ViamVjdD48YXV0aG9yZWRPbiB2YWx1ZT0iMjAyNC0wMi0yNyIvPjxyZXF1ZXN0ZXI+PHJlZmVyZW5jZSB2YWx1ZT0iUHJhY3RpdGlvbmVyL2Y3ODQ5YTg3LTA4ZWQtNDY2NC1iMjdhLTY2ODIyY2ViNTBmZSIvPjwvcmVxdWVzdGVyPjxpbnN1cmFuY2U+PHJlZmVyZW5jZSB2YWx1ZT0iQ292ZXJhZ2UvZThjYTA4NGMtZTI3OS00ZGFiLWI4NTgtMDc5MDgwODRhNTRlIi8+PC9pbnN1cmFuY2U+PGRvc2FnZUluc3RydWN0aW9uPjxleHRlbnNpb24gdXJsPSJodHRwczovL2ZoaXIua2J2LmRlL1N0cnVjdHVyZURlZmluaXRpb24vS0JWX0VYX0VSUF9Eb3NhZ2VGbGFnIj48dmFsdWVCb29sZWFuIHZhbHVlPSJ0cnVlIi8+PC9leHRlbnNpb24+PHRleHQgdmFsdWU9IjAtMC0yLTAtMC0wIi8+PC9kb3NhZ2VJbnN0cnVjdGlvbj48ZGlzcGVuc2VSZXF1ZXN0PjxxdWFudGl0eT48dmFsdWUgdmFsdWU9IjgiLz48c3lzdGVtIHZhbHVlPSJodHRwOi8vdW5pdHNvZm1lYXN1cmUub3JnIi8+PGNvZGUgdmFsdWU9IntQYWNrYWdlfSIvPjwvcXVhbnRpdHk+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";
  private static final String EXPECTED_HASH_FROM_MESSAGE_DIGEST =
      "eNMcZvslUsx75vwaQd4McWdHcfjHELsX/y02wsbRjlo=";

  @Test
  void shouldCompareSignature() {
    val erxReceipt =
        parser.decode(
            ErxReceipt.class,
            ResourceLoader.readFileFromResource(
                "fhir/valid/erp/1.2.0/receiptbundle/org_fd_response.xml"));
    val step =
        ReceiptBundleVerifier.compareSignatureHashWith(
            Base64.getDecoder().decode(SIGNED_DOC_AS_BASE64), ErpAfos.A_19233);
    step.apply(erxReceipt);
  }

  @Test
  void shouldFailAtCompareSignature() {
    val erxReceipt =
        parser.decode(
            ErxReceipt.class,
            ResourceLoader.readFileFromResource(
                "fhir/valid/erp/1.2.0/receiptbundle/NeueVersion_0e0f861-0000-0000-0003-000000000000.xml"));
    val step =
        ReceiptBundleVerifier.compareSignatureHashWith(
            Base64.getDecoder().decode(SIGNED_DOC_AS_BASE64), ErpAfos.A_19233);
    assertThrows(AssertionError.class, () -> step.apply(erxReceipt));
  }

  @Test
  void shouldGetHashFromSignedDoc() {
    val hash = ReceiptBundleVerifier.getHashAsBase64String(SIGNED_DOC_AS_BASE64);
    assertEquals(EXPECTED_HASH_FROM_MESSAGE_DIGEST, hash);
  }

  @Test
  void shouldFailToGetHashFromSignedDoc() {
    val hash = ReceiptBundleVerifier.getHashAsBase64String(SIGNED_DOC_AS_BASE64);
    assertNotEquals(EXPECTED_HASH_FROM_MESSAGE_DIGEST + "=", hash);
  }

  @Test
  void hashShouldNotBeEmpty() {
    val hash = ReceiptBundleVerifier.getHashAsBase64String(SIGNED_DOC_AS_BASE64);
    assertFalse(hash.isEmpty());
  }

  @Test
  void shouldThrowException() {
    assertThrows(
        IllegalArgumentException.class,
        () -> {
          val hash = ReceiptBundleVerifier.getHashAsBase64String(SIGNED_DOC_AS_BASE64 + "123");
        });
  }
}
